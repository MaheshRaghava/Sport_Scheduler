<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin Dashboard | Sport Scheduler</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Poppins:400,500,600,700&display=swap" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <style>
    :root {
      --primary: #1db954;
      --primary-dark: #17a44b;
      --glass: rgba(255,255,255,0.09);
      --glass-dark: rgba(0,0,0,0.4);
      --shadow: 0 4px 18px rgba(0,0,0,0.24);
      --bg-dark: #0f2027;
      --bg-mid: #203a43;
      --bg-light: #2c5364;
      --card-bg: rgba(30, 50, 60, 0.92);
      --border: #14532d;
      --error: #ff8181;
      --success: #1db954;
    }
    body {
      font-family: "Poppins", Arial, sans-serif;
      margin: 0;
      background: linear-gradient(135deg, var(--bg-dark), var(--bg-mid), var(--bg-light));
      color: #fff;
      min-height: 100vh;
    }
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 22px 60px 18px 60px;
      background: var(--glass-dark);
      border-bottom: 1.5px solid var(--border);
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 2px 20px 0 rgba(20,40,30,.11);
      backdrop-filter: blur(8px);
    }
    .logo-admin {
      display: flex;
      align-items: center;
      gap: 13px;
      font-size: 2rem;
      font-weight: 700;
      color: var(--primary);
      letter-spacing: 0.5px;
    }
    .logo-admin i {
      font-size: 2.2rem;
      color: var(--primary);
    }
    .admin-info {
      display: flex;
      align-items: center;
      gap: 22px;
    }
    .admin-badge {
      background: var(--primary-dark);
      color: #fff;
      font-size: 13px;
      font-weight: 600;
      border-radius: 12px;
      padding: 3.5px 18px;
      letter-spacing: 1.2px;
      margin-right: 10px;
    }
    .logout-btn {
      background: none;
      border: none;
      color: #fff;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 7px;
      transition: color 0.17s;
    }
    .logout-btn:hover { color: var(--error); }
    .main-content {
      max-width: 1350px;
      margin: 40px auto 0 auto;
      padding: 0 16px 50px 16px;
    }
    .stats-row {
      display: flex;
      gap: 28px;
      margin-bottom: 33px;
      flex-wrap: wrap;
    }
    .stat-card {
      flex: 1 1 200px;
      background: var(--card-bg);
      border-radius: 18px;
      box-shadow: var(--shadow);
      padding: 26px 32px 21px 32px;
      min-width: 180px;
      display: flex;
      align-items: center;
      gap: 16px;
      border: 1.5px solid var(--border);
    }
    .stat-icon {
      background: #1db95433;
      color: var(--primary);
      border-radius: 12px;
      padding: 18px 17px;
      font-size: 2.1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 12px;
    }
    .stat-info {
      display: flex;
      flex-direction: column;
      justify-content: center;
    }
    .stat-label {
      font-size: 1rem;
      color: #b8eecb;
      font-weight: 500;
      margin-bottom: 3px;
    }
    .stat-value {
      font-size: 1.8rem;
      font-weight: 700;
      color: #fff;
    }
    .tabs-row {
      display: flex;
      gap: 10px;
      margin-bottom: 24px;
      margin-top: 18px;
      flex-wrap: wrap;
    }
    .tab-btn {
      padding: 9px 32px;
      border-radius: 12px 12px 0 0;
      background: rgba(255,255,255,0.13);
      border: none;
      color: #b8eecb;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.14s, color 0.14s;
      font-family: inherit;
      border-bottom: 2px solid transparent;
    }
    .tab-btn.active, .tab-btn:hover {
      background: #fff;
      color: var(--primary);
      font-weight: 700;
      border-bottom: 2.5px solid var(--primary);
    }
    .tab-content {
      background: var(--card-bg);
      border-radius: 0 0 18px 18px;
      box-shadow: var(--shadow);
      padding: 30px 22px 18px 22px;
      border: 1.5px solid var(--border);
      border-top: none;
      margin-bottom: 28px;
      min-height: 120px;
      overflow-x: auto;
    }
    /* Sports Management */
    .sports-mgmt-title {
      font-size: 1.3rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
      color: #fff;
    }
    .add-sport-row {
      display: flex;
      gap: 10px;
      margin-bottom: 22px;
      align-items: center;
    }
    .add-sport-row input {
      flex: 1;
      padding: 12px 12px;
      border-radius: 9px;
      border: 1.5px solid var(--primary-dark);
      background: rgba(255,255,255,0.1);
      color: #fff;
      font-size: 1rem;
      outline: none;
      transition: border 0.17s;
    }
    .add-sport-row input:focus {
      border: 1.5px solid #fff;
      background: #183029;
    }
    .add-sport-btn {
      background: var(--primary);
      color: #fff;
      font-size: 1.1rem;
      font-weight: 600;
      border: none;
      border-radius: 9px;
      padding: 13px 26px;
      cursor: pointer;
      transition: background 0.17s;
      margin-left: 5px;
    }
    .add-sport-btn:hover { background: var(--primary-dark);}
    .sports-list {
      display: flex;
      flex-direction: column;
      gap: 14px;
    }
    .sport-item {
      background: rgba(255,255,255,0.08);
      border-radius: 11px;
      padding: 17px 20px 17px 17px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border: 1.2px solid var(--primary-dark);
      box-shadow: 0 2px 10px rgba(0,0,0,0.06);
    }
    .sport-info {
      display: flex;
      align-items: center;
      gap: 13px;
    }
    .sport-icon {
      background: #1db95433;
      color: var(--primary);
      border-radius: 11px;
      padding: 10px 11px;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .sport-details {
      display: flex;
      flex-direction: column;
    }
    .sport-name {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 2px;
      color: #fff;
    }
    .sport-meta {
      font-size: 0.98rem;
      color: #b8eecb;
    }
    .sport-actions {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .sport-status {
      background: #0bbd5c33;
      color: var(--primary);
      font-weight: 600;
      font-size: 14px;
      border-radius: 7px;
      padding: 3px 17px;
      margin-right: 6px;
      border: none;
      outline: none;
    }
    .edit-btn, .delete-btn {
      background: none;
      border: none;
      color: #b8eecb;
      font-size: 1.15rem;
      cursor: pointer;
      transition: color 0.15s;
    }
    .edit-btn:hover { color: var(--primary); }
    .delete-btn:hover { color: var(--error); }
    /* Modal and form scrollable styles */
    .modal-backdrop {
      display: none;
      position: fixed;
      z-index: 2000;
      left: 0; top: 0; right: 0; bottom: 0;
      background: rgba(20,30,40,0.68);
      backdrop-filter: blur(8px);
      justify-content: center;
      align-items: center;
    }
    .modal-backdrop.active { display: flex; }
    .modal-content {
      background: var(--card-bg);
      border-radius: 22px;
      max-width: 440px;
      width: 98vw;
      margin: auto;
      box-shadow: 0 8px 36px #151e28bb;
      color: #fff;
      position: relative;
      display: flex;
      flex-direction: column;
      animation: fadeInModal .3s cubic-bezier(.7,-0.08,.62,1.09);
      max-height: 95vh;
      overflow: hidden;
    }
    @keyframes fadeInModal {
      from { opacity: 0; transform: translateY(40px) scale(0.98);}
      to   { opacity: 1; transform: none;}
    }
    .modal-close {
      position: absolute;
      top: 18px; right: 22px;
      font-size: 32px;
      background: none;
      border: none;
      color: var(--primary);
      cursor: pointer;
      font-weight: 700;
      transition: color .18s;
      z-index: 1;
    }
    .modal-close:hover { color: #fff; }
    .modal-heading {
      font-size: 2rem;
      font-weight: 600;
      margin-bottom: 24px;
      letter-spacing: 0.5px;
      color: #fff;
      text-align: center;
      margin-top: 32px;
    }
    .scrollable-form-area {
      overflow-y: auto;
      padding: 22px 34px 22px 34px;
      flex: 1 1 auto;
      max-height: 70vh;
    }
    .form-group {
      margin-bottom: 15px;
      display: flex;
      flex-direction: column;
      gap: 7px;
    }
    .form-row {
      display: flex;
      gap: 16px;
      margin-bottom: 15px;
    }
    label {
      font-size: 1.09rem;
      color: #b8eecb;
      font-weight: 500;
      letter-spacing: 0.1px;
    }
    input, select, textarea {
      background: rgba(255,255,255,0.13);
      border: 1.5px solid #1db95455;
      color: #fff;
      border-radius: 9px;
      padding: 12px 12px;
      font-size: 1rem;
      font-family: inherit;
      outline: none;
      transition: border 0.17s, box-shadow 0.18s;
      box-shadow: 0 2px 13px rgba(29,185,84,0.06);
      resize: none;
    }
    input:focus, select:focus, textarea:focus {
      border: 1.5px solid #1db954;
      box-shadow: 0 0 0 1.5px #21c46466;
      background: rgba(35, 50, 80, 0.97);
    }
    .modal-submit {
      width: 100%;
      background: linear-gradient(90deg, #1db954 60%, #17a44b 100%);
      color: #fff;
      font-size: 1.17rem;
      font-weight: 600;
      padding: 15px 0;
      border: none;
      border-radius: 9px;
      margin-top: 15px;
      box-shadow: 0 2px 18px #1db9544a;
      cursor: pointer;
      transition: background 0.17s, box-shadow 0.17s;
      letter-spacing: 0.5px;
      margin-bottom: 18px;
    }
    .modal-submit:hover {
      background: #19a347;
      box-shadow: 0 5px 22px #1db95450;
    }
    .player-emails-list {
      display: flex; flex-wrap: wrap; gap: 7px;
      margin-bottom: 7px;
    }
    .player-email-item {
      background: #1db954ee;
      color: #fff;
      border-radius: 6px;
      padding: 4px 11px;
      font-size: 0.94rem;
      margin-right: 4px;
      display: flex; align-items: center;
      gap: 5px;
    }
    .remove-player-btn {
      background: none;
      border: none;
      color: #fff;
      font-weight: bold;
      font-size: 1.1em;
      cursor: pointer;
      margin-left: 3px;
      padding: 0 2px;
    }
    .add-player-row {
      display: flex; gap: 5px; margin-bottom: 10px;
    }
    .add-player-row input {
      flex: 1;
    }
    .add-player-btn {
      background: #1db954;
      color: #fff;
      border: none;
      border-radius: 7px;
      font-size: 16px;
      font-weight: 600;
      padding: 4px 14px;
      cursor: pointer;
      margin-left: 2px;
      transition: background 0.17s;
    }
    .add-player-btn:hover { background: #17a44b; }
    .manage-sessions-list, .cancelled-sessions-list, .available-sessions-list {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .session-box {
      background: rgba(255,255,255,0.10);
      border-radius: 14px;
      padding: 18px 24px 18px 18px;
      border: 1.5px solid var(--primary-dark);
      box-shadow: 0 2px 10px rgba(0,0,0,0.10);
      margin-bottom: 5px;
      position: relative;
      min-width: 260px;
    }
    .session-title {
      font-size: 1.27rem;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 7px;
    }
    .session-info-row {
      margin-bottom: 3px;
      font-size: 1.01rem;
      color: #b8eecb;
    }
    .session-info-row strong {
      color: #fff;
      display: inline-block;
      min-width: 100px;
    }
    .session-teams-row {
      margin-bottom: 3px;
      font-size: 1.01rem;
      color: #b8eecb;
    }
    .session-teams-row strong {
      color: #fff;
      display: inline-block;
      min-width: 100px;
    }
    .session-description-row {
      color: #fff;
      margin-bottom: 2px;
      font-size: 1.01rem;
    }
    .session-actions {
      position: absolute;
      right: 18px; top: 20px;
      display: flex; gap: 7px;
    }
    .edit-session-btn, .delete-session-btn {
      background: none;
      border: none;
      font-size: 1.19rem;
      color: #b8eecb;
      cursor: pointer;
      transition: color 0.15s;
    }
    .edit-session-btn:hover { color: var(--primary); }
    .delete-session-btn:hover { color: var(--error);}
    .action-btn {
      padding: 8px 21px; border-radius: 9px;
      border: none; font-size: 15px; font-weight: 600;
      cursor: pointer;
      background: var(--primary); color: #fff;
      transition: background 0.13s;
      font-family: inherit;
      box-shadow: 0 1px 4px rgba(29,185,84,0.19);
    }
    .action-btn.cancel { background: #e84b4b; }
    .action-btn.joined, .action-btn:disabled { background: #c8e6ce; color: var(--primary); cursor: not-allowed;}
    .action-btn.join { background: var(--primary); }
    .action-btn:hover:not(:disabled) { filter: brightness(0.93);}
    .session-status {
      font-size: 13px; font-weight: 600;
      padding: 1px 11px; border-radius: 8px; margin-left: 7px;
      background: #eaf8ec; color: var(--primary);
      border: 1px solid #caeeca;
      display: inline-block;
    }
    .session-status.cancelled {
      background: #ffeaea; color: #ff4c4c; border: 1px solid #ffdada;
    }
    .session-status.joined {
      background: #eaf8ec; color: var(--primary); border: 1px solid #caeeca;
    }
    .cancelled-by-row {
      color: var(--error);
      margin-top: 5px;
      font-size: 0.98rem;
      font-style: italic;
    }
    .cancel-reason-row {
      color: var(--error);
      font-size: 0.97rem;
      margin-top: 2px;
      font-style: italic;
    }
    /* Reports Tab Styles */
    .reports-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 25px;
      margin-bottom: 30px;
    }
    .report-card {
      background: rgba(255,255,255,0.08);
      border-radius: 15px;
      padding: 25px;
      border: 1.5px solid var(--primary-dark);
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    .report-title {
      font-size: 1.3rem;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .chart-container {
      width: 100%;
      height: 250px;
      position: relative;
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }
    .stat-item {
      background: rgba(255,255,255,0.05);
      padding: 15px;
      border-radius: 10px;
      text-align: center;
    }
    .stat-number {
      font-size: 2rem;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 5px;
    }
    .stat-label {
      font-size: 0.9rem;
      color: #b8eecb;
    }
    .export-btn {
      background: var(--primary);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      margin-top: 20px;
      transition: background 0.3s;
    }
    .export-btn:hover {
      background: var(--primary-dark);
    }
    @media (max-width: 1020px) {
      .stats-row { flex-direction: column; gap: 17px;}
      .stat-card { min-width: 120px; }
      .reports-container {
        grid-template-columns: 1fr;
      }
    }
    @media (max-width: 700px) {
      header { padding: 16px 6vw 12px 6vw; }
      .main-content { padding: 0 2vw 32px 2vw;}
      .tabs-row {
        overflow-x: auto;
        padding-bottom: 10px;
      }
    }
    @media (max-width: 500px) {
      .modal-content { padding: 0;}
      .scrollable-form-area { padding: 6vw 3vw 6vw 3vw;}
      .form-row { flex-direction: column; gap: 7px;}
      .modal-heading { font-size: 1.2rem;}
      .stat-card { padding: 16px 9px 14px 9px; gap: 7px;}
      .main-content { margin-top: 15px; }
      .stats-grid {
        grid-template-columns: 1fr;
      }
    }
    /* Hide admin-sessions-list under Create Session tab */
    #admin-sessions-list { display: none !important; }
  </style>
</head>
<body>
  <header>
    <div class="logo-admin">
      <i class="fas fa-trophy"></i>
      Admin Dashboard
    </div>
    <div class="admin-info">
      <span class="admin-badge">Admin</span>
      <button class="logout-btn" onclick="logout()">
        <i class="fas fa-sign-out-alt"></i> Logout
      </button>
    </div>
  </header>
  <div class="main-content">
    <!-- Stats Cards -->
    <div class="stats-row">
      <div class="stat-card">
        <span class="stat-icon"><i class="fas fa-trophy"></i></span>
        <div class="stat-info">
          <span class="stat-label">Total Sports</span>
          <span class="stat-value" id="stat-total-sports">0</span>
        </div>
      </div>
      <div class="stat-card">
        <span class="stat-icon"><i class="fas fa-calendar-alt"></i></span>
        <div class="stat-info">
          <span class="stat-label">Total Sessions</span>
          <span class="stat-value" id="stat-total-sessions">0</span>
        </div>
      </div>
      <div class="stat-card">
        <span class="stat-icon"><i class="fas fa-users"></i></span>
        <div class="stat-info">
          <span class="stat-label">Active Players</span>
          <span class="stat-value" id="stat-active-players">0</span>
        </div>
      </div>
      <div class="stat-card">
        <span class="stat-icon"><i class="fas fa-user-plus"></i></span>
        <div class="stat-info">
          <span class="stat-label">Available Sessions</span>
          <span class="stat-value" id="stat-available-sessions">0</span>
        </div>
      </div>
    </div>
    <!-- Tabs -->
    <div class="tabs-row">
      <button class="tab-btn active" onclick="showTab('sports')">Manage Sports</button>
      <button class="tab-btn" onclick="showTab('create')">Create Sessions</button>
      <button class="tab-btn" onclick="showTab('manage')">Manage Sessions</button>
      <button class="tab-btn" onclick="showTab('available')">Available Sessions</button>
      <button class="tab-btn" onclick="showTab('joined')">Joined Sessions</button>
      <button class="tab-btn" onclick="showTab('cancelled')">Cancelled Sessions</button>
      <button class="tab-btn" onclick="showTab('reports')">Reports</button>
    </div>
    <!-- Manage Sports Tab -->
    <div class="tab-content" id="tab-sports">
      <div class="sports-mgmt-title">
        <i class="fas fa-trophy"></i>
        Sports Management
      </div>
      <div class="add-sport-row">
        <input type="text" id="sport-input" placeholder="Enter sport name" />
        <button class="add-sport-btn" onclick="addSport()">
          <i class="fas fa-plus"></i> Add Sport
        </button>
      </div>
      <div class="sports-list" id="sports-list">
        <!-- Sports will be rendered here -->
      </div>
    </div>
    <!-- Create Session Tab -->
    <div class="tab-content" id="tab-create" style="display:none;">
      <div style="font-size:1.32rem; font-weight:700; margin-bottom:18px;">Create New Session</div>
      <button class="modal-submit" style="margin-bottom:18px;font-size:17px;padding:13px 0;width:100%;border-radius:12px;background:var(--primary);color:#fff;border:none;font-weight:700;transition:background 0.15s;cursor:pointer;box-shadow:0 2px 8px rgba(29,185,84,0.12);" onclick="openSessionModal()">
        + Create New Session
      </button>
      <div id="admin-sessions-list"></div>
    </div>
    <!-- Manage Sessions Tab -->
    <div class="tab-content" id="tab-manage" style="display:none;">
      <div style="font-size:1.22rem;font-weight:600;margin-bottom:11px;">Manage Sessions</div>
      <div class="manage-sessions-list" id="manage-sessions-list"></div>
    </div>
    <!-- Available Sessions Tab -->
    <div class="tab-content" id="tab-available" style="display:none;">
      <div style="font-size:1.22rem;font-weight:600;margin-bottom:11px;">Available Sessions</div>
      <div class="available-sessions-list" id="available-sessions-list"></div>
    </div>
    <!-- Joined Sessions Tab -->
    <div class="tab-content" id="tab-joined" style="display:none;">
      <div style="font-size:1.22rem;font-weight:600;margin-bottom:11px;">Joined Sessions</div>
      <div id="admin-joined-sessions"></div>
    </div>
    <!-- Cancelled Sessions Tab -->
    <div class="tab-content" id="tab-cancelled" style="display:none;">
      <div style="font-size:1.22rem;font-weight:600;margin-bottom:11px;">Cancelled Sessions</div>
      <div class="cancelled-sessions-list" id="cancelled-sessions-list"></div>
    </div>
    <!-- Reports Tab -->
    <div class="tab-content" id="tab-reports" style="display:none;">
      <div style="font-size:1.22rem;font-weight:600;margin-bottom:11px;">Analytics & Reports</div>
      
      <div class="reports-container">
        <!-- Session Analytics -->
        <div class="report-card">
          <div class="report-title">
            <i class="fas fa-chart-line"></i>
            Session Analytics
          </div>
          <div class="stats-grid">
            <div class="stat-item">
              <div class="stat-number" id="total-sessions-count">0</div>
              <div class="stat-label">Total Sessions</div>
            </div>
            <div class="stat-item">
              <div class="stat-number" id="upcoming-sessions-count">0</div>
              <div class="stat-label">Upcoming Sessions</div>
            </div>
            <div class="stat-item">
              <div class="stat-number" id="completed-sessions-count">0</div>
              <div class="stat-label">Completed Sessions</div>
            </div>
            <div class="stat-item">
              <div class="stat-number" id="cancellation-rate">0%</div>
              <div class="stat-label">Cancellation Rate</div>
            </div>
          </div>
        </div>

        <!-- Sport Popularity -->
        <div class="report-card">
          <div class="report-title">
            <i class="fas fa-chart-pie"></i>
            Sport Popularity
          </div>
          <div id="sport-popularity-chart" class="chart-container">
            <!-- Chart will be rendered here -->
            <div style="display:flex; flex-direction:column; gap:10px; margin-top:20px;" id="sport-stats-list">
              <!-- Sport stats will be populated here -->
            </div>
          </div>
        </div>
      </div>

      <button class="export-btn" onclick="exportReports()">
        <i class="fas fa-download"></i> Export Report as PDF
      </button>
    </div>
  </div>

  <!-- Modal: Create Session -->
  <div class="modal-backdrop" id="session-modal-backdrop" style="display:none;">
    <div class="modal-content">
      <button class="modal-close" onclick="closeSessionModal()">&times;</button>
      <div class="modal-heading">Create New Session</div>
      <div class="scrollable-form-area">
      <form id="admin-create-session-form" autocomplete="off">
        <div class="form-group">
          <label for="admin-sport">Sport</label>
          <select id="admin-sport" required>
            <option value="">Select sport</option>
          </select>
        </div>
        <div class="form-group">
          <label for="admin-venue">Venue</label>
          <input type="text" id="admin-venue" placeholder="Enter venue location" required />
        </div>
        <div class="form-group">
          <label>Team 1 Players</label>
          <div class="player-emails-list" id="admin-team1-list"></div>
          <div class="add-player-row">
            <input type="email" id="admin-team1-input" placeholder="Enter player email" />
            <button type="button" class="add-player-btn" onclick="addAdminPlayer('team1')">+</button>
          </div>
        </div>
        <div class="form-group">
          <label>Team 2 Players</label>
          <div class="player-emails-list" id="admin-team2-list"></div>
          <div class="add-player-row">
            <input type="email" id="admin-team2-input" placeholder="Enter player email" />
            <button type="button" class="add-player-btn" onclick="addAdminPlayer('team2')">+</button>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group" style="flex:1;">
            <label for="admin-date">Date</label>
            <input type="date" id="admin-date" required min="" />
          </div>
          <div class="form-group" style="flex:1;">
            <label for="admin-time">Time</label>
            <input type="time" id="admin-time" required min="" />
          </div>
        </div>
        <div class="form-group">
          <label for="admin-required">How many players required?</label>
          <input type="number" id="admin-required" min="0" placeholder="Required players" />
        </div>
        <div class="form-group">
          <label for="admin-description">Description (Optional)</label>
          <textarea id="admin-description" rows="2" placeholder="Add session details..."></textarea>
        </div>
        <button class="modal-submit" type="submit">Create Session</button>
      </form>
      </div>
    </div>
  </div>
  <!-- Modal: Edit Session (structure matches create, JS handles filling fields) -->
  <div class="modal-backdrop" id="edit-session-modal-backdrop" style="display:none;">
    <div class="modal-content">
      <button class="modal-close" onclick="closeEditSessionModal()">&times;</button>
      <div class="modal-heading">Edit Session</div>
      <div class="scrollable-form-area">
      <form id="admin-edit-session-form" autocomplete="off">
        <input type="hidden" id="edit-session-id" />
        <div class="form-group">
          <label for="edit-admin-sport">Sport</label>
          <select id="edit-admin-sport" required>
            <option value="">Select sport</option>
          </select>
        </div>
        <div class="form-group">
          <label for="edit-admin-venue">Venue</label>
          <input type="text" id="edit-admin-venue" placeholder="Enter venue location" required />
        </div>
        <div class="form-group">
          <label>Team 1 Players</label>
          <div class="player-emails-list" id="edit-admin-team1-list"></div>
          <div class="add-player-row">
            <input type="email" id="edit-admin-team1-input" placeholder="Enter player email" />
            <button type="button" class="add-player-btn" onclick="addEditAdminPlayer('team1')">+</button>
          </div>
        </div>
        <div class="form-group">
          <label>Team 2 Players</label>
          <div class="player-emails-list" id="edit-admin-team2-list"></div>
          <div class="add-player-row">
            <input type="email" id="edit-admin-team2-input" placeholder="Enter player email" />
            <button type="button" class="add-player-btn" onclick="addEditAdminPlayer('team2')">+</button>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group" style="flex:1;">
            <label for="edit-admin-date">Date</label>
            <input type="date" id="edit-admin-date" required min="" />
          </div>
          <div class="form-group" style="flex:1;">
            <label for="edit-admin-time">Time</label>
            <input type="time" id="edit-admin-time" required min="" />
          </div>
        </div>
        <div class="form-group">
          <label for="edit-admin-required">How many players required?</label>
          <input type="number" id="edit-admin-required" min="0" placeholder="Required players" />
        </div>
        <div class="form-group">
          <label for="edit-admin-description">Description (Optional)</label>
          <textarea id="edit-admin-description" rows="2" placeholder="Add session details..."></textarea>
        </div>
        <button class="modal-submit" type="submit">Save Changes</button>
      </form>
      </div>
    </div>
  </div>
  <script>
    // Helper Functions
function formatDate(dtStr) {
  const dt = new Date(dtStr);
  return dt.toLocaleString('en-IN', {
    day: '2-digit', month: 'short', year: '2-digit', hour: '2-digit', minute: '2-digit'
  });
}

function renderTeamInfo(session) {
  let team1Players = Array.isArray(session.team1) ? session.team1 : [];
  let team2Players = Array.isArray(session.team2) ? session.team2 : [];
  
  // If teams aren't defined but playerEmails are, split them into two teams
  if ((team1Players.length === 0 || team2Players.length === 0) && session.playerEmails && session.playerEmails.length > 0) {
    const allPlayers = session.playerEmails.map(p => p.email);
    const half = Math.ceil(allPlayers.length / 2);
    team1Players = allPlayers.slice(0, half);
    team2Players = allPlayers.slice(half);
  }
  
  return `
    <div class="session-teams-row"><strong>Team 1 Players:</strong> ${team1Players.join(', ')}</div>
    <div class="session-teams-row"><strong>Team 2 Players:</strong> ${team2Players.join(', ')}</div>
  `;
}
    // Data State
    let sports = [];
    let sessions = [];
    let players = [];
    let adminTeam1Emails = [];
    let adminTeam2Emails = [];
    let editTeam1Emails = [];
    let editTeam2Emails = [];
    let cancelledSessionsData = [];
    let adminEmail = "";

    // Initial Load Function
    async function reloadAdminData() {
      try {
        sports = await fetchSports();
        sessions = await fetchSessions();
        players = await fetchPlayers();
        cancelledSessionsData = await fetchCancelledSessions();
        renderSports();
        renderManageSessions();
        renderAvailableSessions();
        renderJoinedSessions();
        renderCancelledSessions();
        renderReports();
        fetchStats();
      } catch (error) {
        console.error('Error reloading admin data:', error);
      }
    }

    // API Helpers
    async function fetchSports() {
      try {
        const res = await fetch('/api/sports');
        return res.ok ? await res.json() : [];
      } catch (error) {
        console.error('Error fetching sports:', error);
        return [];
      }
    }

    async function fetchSessions() {
      try {
        const res = await fetch('/api/sessions/admin');
        return res.ok ? await res.json() : [];
      } catch (error) {
        console.error('Error fetching sessions:', error);
        return [];
      }
    }

    async function fetchPlayers() {
      try {
        const res = await fetch('/api/users/players');
        return res.ok ? await res.json() : [];
      } catch (error) {
        console.error('Error fetching players:', error);
        return [];
      }
    }

    async function fetchCancelledSessions() {
      try {
        const res = await fetch('/api/sessions/cancelled-by-players');
        return res.ok ? await res.json() : [];
      } catch (error) {
        console.error('Error fetching cancelled sessions:', error);
        return [];
      }
    }
    async function fetchStats() {
  try {
    const [sportsArr, sessionsArr, playersArr] = await Promise.all([
      fetchSports(), 
      fetchSessions(), 
      fetchPlayers()
    ]);
    
    document.getElementById("stat-total-sports").textContent = sportsArr.length;
    
    const adminSessionsCount = sessionsArr.filter(s => s.createdBy === "admin").length;
    document.getElementById("stat-total-sessions").textContent = adminSessionsCount;
    
    document.getElementById("stat-active-players").textContent = playersArr.length;
    
    // Only set adminEmail if it's not already set manually
    if (!adminEmail) {
      // Check which admin email exists in the sessions
      const adminEmailsToTry = ["maheshraghava@gmail.com", "admin@gmail.com"];
      
      for (const email of adminEmailsToTry) {
        const sessionsWithThisAdmin = sessionsArr.filter(session => {
          return session.playerEmails.some(p => 
            p.email.toLowerCase().trim() === email.toLowerCase().trim()
          );
        });
        
        if (sessionsWithThisAdmin.length > 0) {
          adminEmail = email;
          console.log(`🎯 Auto-detected admin email: ${adminEmail}`);
          break;
        }
      }
      
      // Fallback if no sessions found
      if (!adminEmail) {
        adminEmail = localStorage.getItem('adminEmail') || "maheshraghava@gmail.com";
      }
    }
    
    console.log(`🔑 Using admin email: ${adminEmail}`);
    
    // Save for future use
    if (adminEmail) {
      localStorage.setItem('adminEmail', adminEmail);
    }
    
    // Calculate available sessions
    const availableSessions = sessionsArr.filter(session => {
      const normalizedAdminEmail = adminEmail.toLowerCase().trim();
      const adminPlayer = session.playerEmails.find(p => {
        const normalizedPlayerEmail = p.email.toLowerCase().trim();
        return normalizedPlayerEmail === normalizedAdminEmail && !p.joined && !p.cancelled;
      });
      return adminPlayer !== undefined;
    });
    
    document.getElementById("stat-available-sessions").textContent = availableSessions.length;
  } catch (error) {
    console.error('Error fetching stats:', error);
  }
}
        // Load data when page is ready (FIXED VERSION)
    document.addEventListener('DOMContentLoaded', function() {
      console.log("🔄 Admin Dashboard Loading...");
      reloadAdminData();
    });

    // Tabs
    function showTab(tab) {
      const tabs = ["sports","create","manage","available","joined","cancelled","reports"];
      tabs.forEach(t => {
        document.getElementById('tab-'+t).style.display = t === tab ? "" : "none";
      });
      
      document.querySelectorAll('.tab-btn').forEach((btn, idx) => {
        btn.classList.toggle('active', 
          (tab === "sports" && idx === 0) ||
          (tab === "create" && idx === 1) ||
          (tab === "manage" && idx === 2) ||
          (tab === "available" && idx === 3) ||
          (tab === "joined" && idx === 4) ||
          (tab === "cancelled" && idx === 5) ||
          (tab === "reports" && idx === 6)
        );
      });
      
      // Refresh specific tab content
      if(tab === "manage") renderManageSessions();
      if(tab === "available") renderAvailableSessions();
      if(tab === "joined") renderJoinedSessions();
      if(tab === "cancelled") renderCancelledSessions();
      if(tab === "reports") renderReports();
    }

    // --- Sports Management ---
    function renderSports() {
      const sportsList = document.getElementById("sports-list");
      if (!sportsList) return;
      
      sportsList.innerHTML = "";
      sports.forEach((sport, idx) => {
        sportsList.innerHTML += `
          <div class="sport-item">
            <div class="sport-info">
              <span class="sport-icon"><i class="fas fa-wave-square"></i></span>
              <div class="sport-details">
                <div class="sport-name">${sport.name}</div>
                <div class="sport-meta">${sessions.filter(s=>s.sport===sport.name).length} sessions created</div>
              </div>
            </div>
            <div class="sport-actions">
              <span class="sport-status">${sport.status||'Active'}</span>
              <button class="edit-btn" title="Edit" onclick="editSport('${sport._id}')"><i class="fas fa-pen"></i></button>
              <button class="delete-btn" title="Delete" onclick="deleteSport('${sport._id}')"><i class="fas fa-trash"></i></button>
            </div>
          </div>
        `;
      });
      updateAdminSportList();
      updateEditAdminSportList();
    }

    async function addSport() {
      const input = document.getElementById("sport-input");
      const name = input.value.trim();
      if(!name) return;
      
      if(sports.some(s=>s.name.toLowerCase()===name.toLowerCase())) { 
        alert("Sport already exists."); 
        return; 
      }
      
      try {
        const res = await fetch('/api/sports', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ name })
        });
        
        if (res.ok) {
          input.value = "";
          await reloadAdminData();
        } else {
          const data = await res.json();
          alert(data.message || "Error adding sport.");
        }
      } catch (error) {
        console.error('Error adding sport:', error);
        alert('Error adding sport');
      }
    }

    async function editSport(id) {
      const sport = sports.find(s=>s._id===id);
      const newName = prompt("Edit sport name:", sport.name);
      if(newName && newName.trim()) {
        if(sports.some((s)=>s._id!==id&&s.name.toLowerCase()===newName.trim().toLowerCase())) { 
          alert("Sport already exists."); 
          return; 
        }
        
        try {
          const res = await fetch(`/api/sports/${id}`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ name: newName.trim() })
          });
          
          if (res.ok) await reloadAdminData();
          else alert('Error editing sport');
        } catch (error) {
          console.error('Error editing sport:', error);
          alert('Error editing sport');
        }
      }
    }

    async function deleteSport(id) {
      if(confirm("Delete this sport?")) {
        try {
          const res = await fetch(`/api/sports/${id}`, { method: 'DELETE' });
          if (res.ok) await reloadAdminData();
          else alert('Error deleting sport');
        } catch (error) {
          console.error('Error deleting sport:', error);
          alert('Error deleting sport');
        }
      }
    }

    function updateAdminSportList() {
      const sel = document.getElementById("admin-sport");
      if (!sel) return;
      sel.innerHTML = `<option value="">Select sport</option>`;
      sports.forEach(sport => {
        sel.innerHTML += `<option value="${sport.name}">${sport.name}</option>`;
      });
    }

    function updateEditAdminSportList() {
      const sel = document.getElementById("edit-admin-sport");
      if (!sel) return;
      sel.innerHTML = `<option value="">Select sport</option>`;
      sports.forEach(sport => {
        sel.innerHTML += `<option value="${sport.name}">${sport.name}</option>`;
      });
    }

    // --- Create Session Modal (admin) ---
    function openSessionModal() {
      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth() + 1).padStart(2, '0');
      const dd = String(today.getDate()).padStart(2, '0');
      
      const dateInput = document.getElementById('admin-date');
      if (dateInput) {
        dateInput.min = `${yyyy}-${mm}-${dd}`;
        dateInput.value = `${yyyy}-${mm}-${dd}`;
      }
      
      updateTimeMin();
      adminTeam1Emails = [];
      adminTeam2Emails = [];
      renderAdminTeamEmails();
      updateAdminSportList();
      
      const modal = document.getElementById('session-modal-backdrop');
      if (modal) {
        modal.style.display = 'flex';
        setTimeout(() => modal.classList.add('active'), 10);
      }
    }

    function closeSessionModal() {
      const modal = document.getElementById('session-modal-backdrop');
      if (modal) {
        modal.classList.remove('active');
        setTimeout(() => { 
          modal.style.display = 'none'; 
        }, 210);
      }
      
      const form = document.getElementById('admin-create-session-form');
      if (form) form.reset();
      
      adminTeam1Emails = [];
      adminTeam2Emails = [];
      renderAdminTeamEmails();
    }

    function addAdminPlayer(team) {
      const input = document.getElementById("admin-"+team+"-input");
      if (!input) return;
      
      const email = input.value.trim();
      if (!email || !/^[^@]+@[^@]+\.[^@]+$/.test(email)) { 
        input.value = ""; 
        return; 
      }
      
      if(team === "team1") {
        if (!adminTeam1Emails.includes(email)) adminTeam1Emails.push(email);
      } else {
        if (!adminTeam2Emails.includes(email)) adminTeam2Emails.push(email);
      }
      
      input.value = "";
      renderAdminTeamEmails();
    }

    function removeAdminPlayer(team, idx) {
      if(team === "team1") adminTeam1Emails.splice(idx, 1);
      else adminTeam2Emails.splice(idx, 1);
      renderAdminTeamEmails();
    }

    function renderAdminTeamEmails() {
      const team1List = document.getElementById("admin-team1-list");
      const team2List = document.getElementById("admin-team2-list");
      
      if (team1List) {
        team1List.innerHTML = adminTeam1Emails.map((e,i) => `
          <span class="player-email-item">${e}<button type="button" class="remove-player-btn" onclick="removeAdminPlayer('team1',${i})">&times;</button></span>
        `).join('');
      }
      
      if (team2List) {
        team2List.innerHTML = adminTeam2Emails.map((e,i) => `
          <span class="player-email-item">${e}<button type="button" class="remove-player-btn" onclick="removeAdminPlayer('team2',${i})">&times;</button></span>
        `).join('');
      }
    }

    function updateTimeMin() {
      const dateInput = document.getElementById('admin-date');
      const timeInput = document.getElementById('admin-time');
      
      if (!dateInput || !timeInput) return;
      
      const selectedDate = dateInput.value;
      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth() + 1).padStart(2, '0');
      const dd = String(today.getDate()).padStart(2, '0');
      
      if (selectedDate === `${yyyy}-${mm}-${dd}`) {
        const now = today.toTimeString().slice(0,5);
        timeInput.min = now;
      } else {
        timeInput.min = "";
      }
    }

    // Add event listener for date change
    document.addEventListener('DOMContentLoaded', function() {
      const dateInput = document.getElementById('admin-date');
      if (dateInput) {
        dateInput.addEventListener('change', updateTimeMin);
      }
    });

    // Form submission handler
    document.addEventListener('DOMContentLoaded', function() {
      const form = document.getElementById('admin-create-session-form');
      if (form) {
        form.onsubmit = async function(e) {
          e.preventDefault();
          
          const sport = document.getElementById("admin-sport")?.value;
          const venue = document.getElementById("admin-venue")?.value;
          const date = document.getElementById("admin-date")?.value;
          const time = document.getElementById("admin-time")?.value;
          const required = document.getElementById("admin-required")?.value;
          const description = document.getElementById("admin-description")?.value;
          
          if(!sport || !venue || !date || !time || !adminTeam1Emails.length || !adminTeam2Emails.length) {
            alert("Please fill all fields and add at least one player in each team.");
            return;
          }
          
          const playerEmails = Array.from(new Set([...adminTeam1Emails, ...adminTeam2Emails]));
          
          try {
            const res = await fetch('/api/sessions', {
              method: 'POST',
              headers: {'Content-Type': 'application/json'},
              body: JSON.stringify({
                sport,
                venue,
                date,
                time,
                playerEmails,
                description,
                requiredPlayers: required,
                createdBy: "admin",
                team1: adminTeam1Emails,
                team2: adminTeam2Emails
              })
            });
            
            if(res.ok) {
              await reloadAdminData();
              closeSessionModal();
              alert("Session created. Added players will see it when they login.");
            } else {
              alert('Error creating session');
            }
          } catch (error) {
            console.error('Error creating session:', error);
            alert('Error creating session');
          }
        };
      }
    });
// Manage Sessions (Admin: edit/delete session)
function renderManageSessions() {
  const container = document.getElementById('manage-sessions-list');
  if (!container) return;
  
  const currentAdminEmail = adminEmail;
  
  if (!currentAdminEmail) {
    container.innerHTML = "<div style='color:#b8eecb;'>Admin email not set. Please refresh.</div>";
    return;
  }
  
  const normalizedAdminEmail = currentAdminEmail.toLowerCase().trim();
  
  // Show BOTH: admin-created sessions AND sessions where admin is mentioned
  const manageableSessions = sessions.filter(session => {
    // Include admin-created sessions
    if (session.createdBy === "admin") return true;
    
    // Include sessions where current admin is mentioned in player list (case-insensitive)
    const adminPlayer = session.playerEmails.find(p => {
      const normalizedPlayerEmail = p.email.toLowerCase().trim();
      return normalizedPlayerEmail === normalizedAdminEmail;
    });
    return adminPlayer !== undefined;
  });
  
  container.innerHTML = manageableSessions.map((s, idx) => `
    <div class="session-box">
      <div class="session-title">${s.sport} 
        ${s.createdBy === "admin" ? '<span style="font-size:12px; color:#1db954;">(Admin Created)</span>' : '<span style="font-size:12px; color:#b8eecb;">(Mentioned by Player)</span>'}
      </div>
      <div class="session-info-row"><strong>Venue:</strong> ${s.venue}</div>
      ${renderTeamInfo(s)}
      <div class="session-info-row"><strong>Date:</strong> ${formatDate(s.date)}</div>
      <div class="session-info-row"><strong>Required Players:</strong> ${s.requiredPlayers || 'Not specified'}</div>
      <div class="session-info-row"><strong>Created By:</strong> ${s.createdBy || 'Player'}</div>
      ${s.description ? `<div class="session-description-row"><strong>Description:</strong> ${s.description}</div>` : ''}
      <div class="session-actions">
        ${s.createdBy === "admin" ? `
          <button class="edit-session-btn" title="Edit" onclick="openEditSessionModal('${s._id}')"><i class="fas fa-pen"></i></button>
          <button class="delete-session-btn" title="Delete" onclick="deleteSession('${s._id}')"><i class="fas fa-trash"></i></button>
        ` : `
          <span style="color:#b8eecb; font-size:12px;">View Only</span>
        `}
      </div>
    </div>
  `).join('') || "<div style='color:#b8eecb;'>No sessions to manage.</div>";
}
    async function deleteSession(id) {
      const session = sessions.find(s => s._id === id);
      
      // Only allow deletion of admin-created sessions
      if (session && session.createdBy !== "admin") {
        alert("You can only delete sessions created by admins.");
        return;
      }
      
      if(confirm("Delete this session?")) {
        try {
          const res = await fetch(`/api/sessions/${id}`, { method: 'DELETE' });
          if (res.ok) await reloadAdminData();
          else alert('Error deleting session');
        } catch (error) {
          console.error('Error deleting session:', error);
          alert('Error deleting session');
        }
      }
    }

    // --- Edit Session Modal ---
    function openEditSessionModal(sessionId) {
      const s = sessions.find(sess => sess._id === sessionId);
      if (!s) return;
      
      // Only allow editing of admin-created sessions
      if (s.createdBy !== "admin") {
        alert("You can only edit sessions created by admins.");
        return;
      }
      
      document.getElementById("edit-session-id").value = s._id;
      document.getElementById("edit-admin-sport").value = s.sport;
      document.getElementById("edit-admin-venue").value = s.venue;
      document.getElementById("edit-admin-date").value = s.date ? s.date.slice(0,10) : "";
      document.getElementById("edit-admin-time").value = s.date ? (new Date(s.date)).toISOString().slice(11,16) : "";
      document.getElementById("edit-admin-required").value = s.requiredPlayers || "";
      document.getElementById("edit-admin-description").value = s.description || "";
      
      editTeam1Emails = Array.isArray(s.team1) ? [...s.team1] : [];
      editTeam2Emails = Array.isArray(s.team2) ? [...s.team2] : [];
      renderEditAdminTeamEmails();
      updateEditAdminSportList();
      
      const modal = document.getElementById('edit-session-modal-backdrop');
      if (modal) {
        modal.style.display = 'flex';
        setTimeout(() => modal.classList.add('active'), 10);
      }
    }

    function closeEditSessionModal() {
      const modal = document.getElementById('edit-session-modal-backdrop');
      if (modal) {
        modal.classList.remove('active');
        setTimeout(() => { 
          modal.style.display = 'none'; 
        }, 210);
      }
      
      const form = document.getElementById('admin-edit-session-form');
      if (form) form.reset();
      
      editTeam1Emails = [];
      editTeam2Emails = [];
      renderEditAdminTeamEmails();
    }

    function addEditAdminPlayer(team) {
      const input = document.getElementById("edit-admin-"+team+"-input");
      if (!input) return;
      
      const email = input.value.trim();
      if (!email || !/^[^@]+@[^@]+\.[^@]+$/.test(email)) { 
        input.value = ""; 
        return; 
      }
      
      if(team === "team1") {
        if (!editTeam1Emails.includes(email)) editTeam1Emails.push(email);
      } else {
        if (!editTeam2Emails.includes(email)) editTeam2Emails.push(email);
      }
      
      input.value = "";
      renderEditAdminTeamEmails();
    }

    function removeEditAdminPlayer(team, idx) {
      if(team === "team1") editTeam1Emails.splice(idx, 1);
      else editTeam2Emails.splice(idx, 1);
      renderEditAdminTeamEmails();
    }

    function renderEditAdminTeamEmails() {
      const team1List = document.getElementById("edit-admin-team1-list");
      const team2List = document.getElementById("edit-admin-team2-list");
      
      if (team1List) {
        team1List.innerHTML = editTeam1Emails.map((e,i) => `
          <span class="player-email-item">${e}<button type="button" class="remove-player-btn" onclick="removeEditAdminPlayer('team1',${i})">&times;</button></span>
        `).join('');
      }
      
      if (team2List) {
        team2List.innerHTML = editTeam2Emails.map((e,i) => `
          <span class="player-email-item">${e}<button type="button" class="remove-player-btn" onclick="removeEditAdminPlayer('team2',${i})">&times;</button></span>
        `).join('');
      }
    }

    // Add event listener for edit date change
    document.addEventListener('DOMContentLoaded', function() {
      const dateInput = document.getElementById('edit-admin-date');
      if (dateInput) {
        dateInput.addEventListener('change', updateEditTimeMin);
      }
    });

    function updateEditTimeMin() {
      const dateInput = document.getElementById('edit-admin-date');
      const timeInput = document.getElementById('edit-admin-time');
      
      if (!dateInput || !timeInput) return;
      
      const selectedDate = dateInput.value;
      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth() + 1).padStart(2, '0');
      const dd = String(today.getDate()).padStart(2, '0');
      
      if (selectedDate === `${yyyy}-${mm}-${dd}`) {
        const now = today.toTimeString().slice(0,5);
        timeInput.min = now;
      } else {
        timeInput.min = "";
      }
    }

    // Edit form submission handler
    document.addEventListener('DOMContentLoaded', function() {
      const form = document.getElementById('admin-edit-session-form');
      if (form) {
        form.onsubmit = async function(e) {
          e.preventDefault();
          
          const id = document.getElementById("edit-session-id")?.value;
          const sport = document.getElementById("edit-admin-sport")?.value;
          const venue = document.getElementById("edit-admin-venue")?.value;
          const date = document.getElementById("edit-admin-date")?.value;
          const time = document.getElementById("edit-admin-time")?.value;
          const required = document.getElementById("edit-admin-required")?.value;
          const description = document.getElementById("edit-admin-description")?.value;
          
          if(!sport || !venue || !date || !time || !editTeam1Emails.length || !editTeam2Emails.length) {
            alert("Please fill all fields and add at least one player in each team.");
            return;
          }
          
          const playerEmails = Array.from(new Set([...editTeam1Emails, ...editTeam2Emails]));
          
          try {
            const res = await fetch(`/api/sessions/${id}`, {
              method: 'PUT',
              headers: {'Content-Type': 'application/json'},
              body: JSON.stringify({
                sport,
                venue,
                date,
                time,
                playerEmails,
                description,
                requiredPlayers: required,
                team1: editTeam1Emails,
                team2: editTeam2Emails
              })
            });
            
            if(res.ok) {
              await reloadAdminData();
              closeEditSessionModal();
              alert("Session updated.");
            } else {
              alert('Error updating session');
            }
          } catch (error) {
            console.error('Error updating session:', error);
            alert('Error updating session');
          }
        };
      }
    });
// Available Sessions Tab (sessions where current admin is listed but hasn't joined)
function renderAvailableSessions() {
  const container = document.getElementById('available-sessions-list');
  if (!container) return;
  
  const currentAdminEmail = adminEmail;
  
  if (!currentAdminEmail) {
    container.innerHTML = "<div style='color:#b8eecb;'>Admin email not set. Please refresh.</div>";
    return;
  }
  
  const availableSessions = sessions.filter(session => {
    const normalizedAdminEmail = currentAdminEmail.toLowerCase().trim();
    const adminPlayer = session.playerEmails.find(p => {
      const normalizedPlayerEmail = p.email.toLowerCase().trim();
      return normalizedPlayerEmail === normalizedAdminEmail && !p.joined && !p.cancelled;
    });
    return adminPlayer !== undefined;
  });
  
  container.innerHTML = availableSessions.map(s => {
    const normalizedAdminEmail = currentAdminEmail.toLowerCase().trim();
    const adminPlayer = s.playerEmails.find(p => 
      p.email.toLowerCase().trim() === normalizedAdminEmail
    );
    const adminEmailToUse = adminPlayer ? adminPlayer.email : currentAdminEmail;
    
    return `
    <div class="session-box">
      <div class="session-title">${s.sport}</div>
      <div class="session-info-row"><strong>Venue:</strong> ${s.venue}</div>
      ${renderTeamInfo(s)}
      <div class="session-info-row"><strong>Date:</strong> ${formatDate(s.date)}</div>
      <div class="session-info-row"><strong>Required Players:</strong> ${s.requiredPlayers || 'Not specified'}</div>
      <div class="session-info-row"><strong>Created By:</strong> ${s.createdBy || 'Player'}</div>
      ${s.description ? `<div class="session-description-row"><strong>Description:</strong> ${s.description}</div>` : ''}
      <div class="session-actions">
        <button class="action-btn join" onclick="adminJoinSession('${s._id}', '${adminEmailToUse}')">Join</button>
      </div>
    </div>
    `;
  }).join('') || "<div style='color:#b8eecb;'>No available sessions.</div>";
}    // Admin Join Session
async function adminJoinSession(sessionId, adminEmailToUse) {
  if(!confirm("Do you want to join this session?")) return;
  
  const emailToUse = adminEmailToUse || adminEmail;
  if (!emailToUse) {
    alert("Admin email not set. Please refresh the page.");
    return;
  }
  
  try {
    const res = await fetch('/api/sessions/join', {
      method: 'PATCH',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ sessionId, playerEmail: emailToUse })
    });
    
    const data = await res.json();
    if(res.ok) {
      alert("Successfully joined the session!");
      // Force reload to update the UI immediately
      await reloadAdminData();
      // Switch to Joined Sessions tab to show the joined session
      showTab('joined');
    } else {
      alert(data.message || "Unable to join session.");
    }
  } catch (error) {
    console.error('Error joining session:', error);
    alert('Unable to join session.');
  }
}

// --- Joined Sessions Tab (sessions where admin has joined) ---
function renderJoinedSessions() {
  const container = document.getElementById('admin-joined-sessions');
  if (!container) return;
  
  const currentAdminEmail = adminEmail;
  const joinedSessions = sessions.filter(session => {
    const player = session.playerEmails.find(p => p.email === currentAdminEmail);
    return player && player.joined && !player.cancelled;
  });
  
  container.innerHTML = joinedSessions.map(s => {
    const normalizedAdminEmail = currentAdminEmail.toLowerCase().trim();
    const adminPlayer = s.playerEmails.find(p => 
      p.email.toLowerCase().trim() === normalizedAdminEmail
    );
    const adminEmailToUse = adminPlayer ? adminPlayer.email : currentAdminEmail;
    
    return `
    <div class="session-box">
      <div class="session-title">${s.sport} <span class="session-status joined">Joined</span></div>
      <div class="session-info-row"><strong>Venue:</strong> ${s.venue}</div>
      ${renderTeamInfo(s)}
      <div class="session-info-row"><strong>Date:</strong> ${formatDate(s.date)}</div>
      <div class="session-info-row"><strong>Required Players:</strong> ${s.requiredPlayers || 'Not specified'}</div>
      <div class="session-info-row"><strong>Created By:</strong> ${s.createdBy || 'Player'}</div>
      ${s.description ? `<div class="session-description-row"><strong>Description:</strong> ${s.description}</div>` : ''}
      <div class="session-actions">
        <button class="action-btn cancel" onclick="adminCancelSession('${s._id}', '${adminEmailToUse}')">Cancel</button>
      </div>
    </div>
    `;
  }).join('') || "<div style='color:#b8eecb;'>No joined sessions.</div>";
}    // --- Admin Cancel Session ---
    async function adminCancelSession(sessionId, adminEmailToUse) {
      const reason = prompt("Enter reason for cancellation:");
      if(reason === null) return;
      
      const emailToUse = adminEmailToUse || adminEmail;
      
      try {
        const res = await fetch('/api/sessions/cancel', {
          method: 'PATCH',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ sessionId, playerEmail: emailToUse, reason })
        });
        
        const data = await res.json();
        if(res.ok) {
          alert("Cancelled session.");
          reloadAdminData();
        } else {
          alert(data.message || "Unable to cancel session.");
        }
      } catch (error) {
        console.error('Error cancelling session:', error);
        alert('Unable to cancel session.');
      }
    }

// --- Cancelled Sessions Tab ---
function renderCancelledSessions() {
  const container = document.getElementById('cancelled-sessions-list');
  if (!container) return;
  
  const currentUserEmail = adminEmail;
  
  // Get TWO types of cancelled sessions:
  
  // Type 1: Sessions where admin personally cancelled
  const sessionsICancelled = sessions.filter(session => {
    const userPlayer = session.playerEmails.find(p => p.email === currentUserEmail);
    return userPlayer && userPlayer.cancelled;
  });
  
  // Type 2: Sessions created by admin that have cancellations
  const sessionsICreatedWithCancellations = sessions.filter(session => {
    const isCreator = session.createdBy === "admin";
    if (!isCreator) return false;
    
    // Check if any player has cancelled this session (excluding self-cancellation for display)
    const otherPlayersCancelled = session.playerEmails.some(p => 
      p.cancelled && p.email !== currentUserEmail
    );
    return otherPlayersCancelled;
  });
  
  // Combine both types
  const allCancelledSessions = [...sessionsICancelled, ...sessionsICreatedWithCancellations];
  
  container.innerHTML = allCancelledSessions.map(s => {
    const isCreator = s.createdBy === "admin";
    const userPlayer = s.playerEmails.find(p => p.email === currentUserEmail);
    const cancelledPlayers = s.playerEmails.filter(p => p.cancelled);
    
    if (isCreator) {
      // Admin created this session, show "Cancelled by Players"
      return `
      <div class="session-box">
        <div class="session-title">${s.sport} <span class="session-status cancelled">Cancelled by Players</span></div>
        <div class="session-info-row"><strong>Venue:</strong> ${s.venue}</div>
        ${renderTeamInfo(s)}
        <div class="session-info-row"><strong>Date:</strong> ${formatDate(s.date)}</div>
        <div class="session-info-row"><strong>Required Players:</strong> ${s.requiredPlayers || 'Not specified'}</div>
        ${s.description ? `<div class="session-description-row"><strong>Description:</strong> ${s.description}</div>` : ''}
        <div class="cancelled-by-row">
          <strong>Players who cancelled:</strong><br/>
          ${cancelledPlayers.filter(p => p.email !== currentUserEmail).map(p => 
            `${p.email} (Reason: ${p.cancelReason || "No reason provided"})`
          ).join('<br/>')}
        </div>
      </div>
      `;
    } else {
      // Admin cancelled this session, show "Cancelled by me"
      return `
      <div class="session-box">
        <div class="session-title">${s.sport} <span class="session-status cancelled">Cancelled by me</span></div>
        <div class="session-info-row"><strong>Venue:</strong> ${s.venue}</div>
        ${renderTeamInfo(s)}
        <div class="session-info-row"><strong>Date:</strong> ${formatDate(s.date)}</div>
        <div class="session-info-row"><strong>Required Players:</strong> ${s.requiredPlayers || 'Not specified'}</div>
        <div class="session-info-row"><strong>Created By:</strong> ${s.createdBy}</div>
        ${s.description ? `<div class="session-description-row"><strong>Description:</strong> ${s.description}</div>` : ''}
        <div class="cancelled-by-row">
          <strong>Your cancellation reason:</strong> ${userPlayer.cancelReason || "No reason provided"}
        </div>
      </div>
      `;
    }
  }).join('') || "<div style='color:#b8eecb;'>No cancelled sessions.</div>";
}

    // Reports Tab
    function renderReports() {
      // Session Analytics
      const totalSessions = sessions.length;
      const now = new Date();
      const upcomingSessions = sessions.filter(s => new Date(s.date) > now).length;
      const completedSessions = sessions.filter(s => new Date(s.date) <= now).length;
      const cancellationRate = totalSessions > 0 ? Math.round((cancelledSessionsData.length / totalSessions) * 100) : 0;

      const totalSessionsEl = document.getElementById('total-sessions-count');
      const upcomingSessionsEl = document.getElementById('upcoming-sessions-count');
      const completedSessionsEl = document.getElementById('completed-sessions-count');
      const cancellationRateEl = document.getElementById('cancellation-rate');
      
      if (totalSessionsEl) totalSessionsEl.textContent = totalSessions;
      if (upcomingSessionsEl) upcomingSessionsEl.textContent = upcomingSessions;
      if (completedSessionsEl) completedSessionsEl.textContent = completedSessions;
      if (cancellationRateEl) cancellationRateEl.textContent = cancellationRate + '%';

      // Sport Popularity
      const sportStats = {};
      sessions.forEach(session => {
        if (!sportStats[session.sport]) {
          sportStats[session.sport] = 0;
        }
        sportStats[session.sport]++;
      });

      const sportStatsList = document.getElementById('sport-stats-list');
      if (sportStatsList) {
        sportStatsList.innerHTML = '';
        
        Object.entries(sportStats)
          .sort((a, b) => b[1] - a[1])
          .forEach(([sport, count]) => {
            const percentage = totalSessions > 0 ? Math.round((count / totalSessions) * 100) : 0;
            sportStatsList.innerHTML += `
              <div style="display:flex; justify-content:space-between; align-items:center;">
                <span>${sport}</span>
                <div style="display:flex; align-items:center; gap:10px;">
                  <div style="width:100px; height:8px; background:rgba(255,255,255,0.2); border-radius:4px;">
                    <div style="width:${percentage}%; height:100%; background:var(--primary); border-radius:4px;"></div>
                  </div>
                  <span>${percentage}% (${count})</span>
                </div>
              </div>
            `;
          });
      }
    }

    function exportReports() {
      alert('Export functionality would generate a PDF report here. This would typically use a library like jsPDF or window.print() for implementation.');
    }

    function logout() {
      if (confirm("Logout from admin dashboard?")) {
        window.location.href = "/login.html";
      }
    }

    // Set min date for session creation to today
    document.addEventListener('DOMContentLoaded', function() {
      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth() + 1).padStart(2, '0');
      const dd = String(today.getDate()).padStart(2, '0');
      
      const dateInput = document.getElementById('admin-date');
      if (dateInput) {
        dateInput.min = `${yyyy}-${mm}-${dd}`;
        dateInput.value = `${yyyy}-${mm}-${dd}`;
      }
    });
  </script>