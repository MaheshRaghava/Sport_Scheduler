<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Player Dashboard | Sport Scheduler</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Poppins:400,500,600,700&display=swap" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <style>
    :root {
      --primary: #1db954;
      --primary-dark: #17a44b;
      --bg-dark: #0f2027;
      --bg-mid: #203a43;
      --bg-light: #2c5364;
      --glass: rgba(255,255,255,0.09);
      --glass-dark: rgba(0,0,0,0.4);
      --shadow: 0 4px 18px rgba(0,0,0,0.24);
      --card-bg: rgba(30, 50, 60, 0.92);
      --border: #14532d;
      --error: #ff8181;
      --success: #1db954;
    }
    * {
      box-sizing: border-box;
    }
    body {
      font-family: "Poppins", sans-serif;
      background: linear-gradient(135deg, var(--bg-dark), var(--bg-mid), var(--bg-light));
      color: #fff;
      margin: 0;
      padding: 0;
      min-height: 100vh;
    }
    header {
      display: flex;
      align-items: center;
      padding: 20px 60px 20px 60px;
      position: fixed;
      top: 0; width: 100%;
      z-index: 100;
      background: var(--glass-dark);
      backdrop-filter: blur(10px);
      box-sizing: border-box;
      justify-content: space-between;
      border-bottom: 1.5px solid var(--border);
    }
    .logo {
      display: flex;
      align-items: center;
      font-size: 2.2rem;
      font-weight: bold;
      color: #fff;
    }
    .logo img {
      height: 64px;
      width: 64px;
      border-radius: 50%;
      margin-right: 15px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.4);
    }
    .user-sec {
      display: flex;
      align-items: center;
      gap: 12px;
      position: relative;
      cursor: pointer;
      user-select: none;
    }
    .avatar {
      width: 38px; height: 38px; border-radius: 50%;
      background: var(--primary-dark); color: #fff; font-weight: 600; font-size: 19px;
      display: flex; align-items: center; justify-content: center;
      box-shadow: var(--shadow);
      transition: box-shadow 0.18s;
    }
    .user-sec:hover .avatar {
      box-shadow: 0 4px 24px rgba(29,185,84,0.23);
    }
    .user-name {
      font-size: 16px;
      font-weight: 500;
      letter-spacing: 0.2px;
    }
    /* Profile Modal */
    .profile-modal-backdrop {
      display: none;
      position: fixed; z-index: 3000;
      left: 0; top: 0; right: 0; bottom: 0;
      background: rgba(20,30,40,0.08);
      backdrop-filter: blur(1px);
      justify-content: flex-end;
      align-items: flex-start;
    }
    .profile-modal-backdrop.active { display: flex; }
    .profile-modal {
      margin-top: 90px;
      margin-right: 70px;
      background: rgba(35, 50, 80, 0.98);
      border-radius: 20px;
      box-shadow: 0 8px 36px #151e2880;
      padding: 35px 38px 28px 38px;
      min-width: 320px;
      max-width: 94vw;
      color: #fff;
      position: relative;
      animation: fadeInModal .23s cubic-bezier(.7,-0.08,.62,1.09);
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .profile-modal .avatar {
      width: 54px; height: 54px; font-size: 28px; margin-bottom: 8px;
    }
    .profile-modal .profile-name {
      font-size: 1.3rem;
      font-weight: 600;
      margin-bottom: 6px;
    }
    .profile-modal .profile-email {
      font-size: 1.07rem;
      color: #b8eecb;
      margin-bottom: 19px;
      word-break: break-all;
    }
    .profile-modal .profile-logout-btn {
      width: 100%;
      background: linear-gradient(90deg, #1db954 60%, #17a44b 100%);
      color: #fff;
      font-size: 1.09rem;
      font-weight: 600;
      padding: 13px 0;
      border: none;
      border-radius: 8px;
      margin-top: 8px;
      box-shadow: 0 2px 18px #1db95436;
      cursor: pointer;
      transition: background 0.17s, box-shadow 0.17s;
      letter-spacing: 0.5px;
    }
    .profile-modal .profile-logout-btn:hover {
      background: #19a347;
      box-shadow: 0 5px 22px #1db95450;
    }
    .profile-modal .close-btn {
      position: absolute;
      top: 13px; right: 19px;
      font-size: 28px;
      background: none; border: none;
      color: #1db954;
      cursor: pointer;
      font-weight: 700;
      transition: color .18s;
    }
    .profile-modal .close-btn:hover { color: #fff; }
    @keyframes fadeInModal {
      from { opacity: 0; transform: translateY(30px) scale(0.98);}
      to   { opacity: 1; transform: none;}
    }
    /* Main Content */
    .main-content {
      max-width: 1350px;
      margin: 120px auto 0 auto;
      padding: 0 16px 50px 16px;
    }
    /* Stats Cards */
    .stats-row {
      display: flex;
      gap: 28px;
      margin-bottom: 33px;
      flex-wrap: wrap;
    }
    .stat-card {
      flex: 1 1 200px;
      background: var(--card-bg);
      border-radius: 18px;
      box-shadow: var(--shadow);
      padding: 26px 32px 21px 32px;
      min-width: 180px;
      display: flex;
      align-items: center;
      gap: 16px;
      border: 1.5px solid var(--border);
    }
    .stat-icon {
      background: #1db95433;
      color: var(--primary);
      border-radius: 12px;
      padding: 18px 17px;
      font-size: 2.1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 12px;
    }
    .stat-info {
      display: flex;
      flex-direction: column;
      justify-content: center;
    }
    .stat-label {
      font-size: 1rem;
      color: #b8eecb;
      font-weight: 500;
      margin-bottom: 3px;
    }
    .stat-value {
      font-size: 1.8rem;
      font-weight: 700;
      color: #fff;
    }
    .stat-next-match {
      font-size: 1.1rem;
      color: var(--primary);
      font-weight: 600;
      margin-top: 5px;
    }
    /* Tabs */
    .tabs-row {
      display: flex;
      gap: 10px;
      margin-bottom: 24px;
      margin-top: 18px;
      flex-wrap: wrap;
    }
    .tab-btn {
      padding: 9px 32px;
      border-radius: 12px 12px 0 0;
      background: rgba(255,255,255,0.13);
      border: none;
      color: #b8eecb;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.14s, color 0.14s;
      font-family: inherit;
      border-bottom: 2px solid transparent;
    }
    .tab-btn.active, .tab-btn:hover {
      background: #fff;
      color: var(--primary);
      font-weight: 700;
      border-bottom: 2.5px solid var(--primary);
    }
    .tab-content {
      background: var(--card-bg);
      border-radius: 0 0 18px 18px;
      box-shadow: var(--shadow);
      padding: 30px 22px 18px 22px;
      border: 1.5px solid var(--border);
      border-top: none;
      margin-bottom: 28px;
      min-height: 120px;
      overflow-x: auto;
    }
    /* Session Lists */
    .manage-sessions-list, .cancelled-sessions-list {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .session-box {
      background: rgba(255,255,255,0.10);
      border-radius: 14px;
      padding: 18px 24px 18px 18px;
      border: 1.5px solid var(--primary-dark);
      box-shadow: 0 2px 10px rgba(0,0,0,0.10);
      margin-bottom: 5px;
      position: relative;
      min-width: 260px;
    }
    .session-title {
      font-size: 1.27rem;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 7px;
    }
    .session-info-row {
      margin-bottom: 3px;
      font-size: 1.01rem;
      color: #b8eecb;
    }
    .session-info-row strong {
      color: #fff;
      display: inline-block;
      min-width: 120px;
    }
    .session-teams-row {
      margin-bottom: 3px;
      font-size: 1.01rem;
      color: #b8eecb;
    }
    .session-teams-row strong {
      color: #fff;
      display: inline-block;
      min-width: 120px;
    }
    .session-description-row {
      color: #fff;
      margin-bottom: 2px;
      font-size: 1.01rem;
    }
    .session-description-row strong {
      color: #fff;
      display: inline-block;
      min-width: 120px;
    }
    .session-actions {
      position: absolute;
      right: 18px; top: 20px;
      display: flex; gap: 7px;
    }
    .edit-session-btn, .delete-session-btn {
      background: none;
      border: none;
      font-size: 1.19rem;
      color: #b8eecb;
      cursor: pointer;
      transition: color 0.15s;
    }
    .edit-session-btn:hover { color: var(--primary); }
    .delete-session-btn:hover { color: var(--error);}
    .action-btn {
      padding: 8px 21px; border-radius: 9px;
      border: none; font-size: 15px; font-weight: 600;
      cursor: pointer;
      background: var(--primary); color: #fff;
      transition: background 0.13s;
      font-family: inherit;
      box-shadow: 0 1px 4px rgba(29,185,84,0.19);
    }
    .action-btn.cancel { background: #e84b4b; }
    .action-btn.joined, .action-btn:disabled { background: #c8e6ce; color: var(--primary); cursor: not-allowed;}
    .action-btn.join { background: var(--primary); }
    .action-btn:hover:not(:disabled) { filter: brightness(0.93);}
    .session-status {
      font-size: 13px; font-weight: 600;
      padding: 1px 11px; border-radius: 8px; margin-left: 7px;
      background: #eaf8ec; color: var(--primary);
      border: 1px solid #caeeca;
      display: inline-block;
    }
    .session-status.cancelled {
      background: #ffeaea; color: #ff4c4c; border: 1px solid #ffdada;
    }
    .session-status.joined {
      background: #eaf8ec; color: var(--primary); border: 1px solid #caeeca;
    }
    .session-cancel-reason {
      font-size: 13px; color: #ff5a5a; margin-top: 3px; font-style: italic;
    }
    .cancelled-by-row {
      color: var(--error);
      margin-top: 5px;
      font-size: 0.98rem;
      font-style: italic;
    }
    .cancel-reason-row {
      color: var(--error);
      font-size: 0.97rem;
      margin-top: 2px;
      font-style: italic;
    }
    .create-session-btn {
      margin-top: 8px; font-size: 17px; padding: 13px 0; width: 100%;
      border-radius: 12px; background: var(--primary); color: #fff; border: none;
      font-weight: 700; transition: background 0.15s; cursor: pointer;
      box-shadow: 0 2px 8px rgba(29,185,84,0.12);
    }
    .create-session-btn:hover { background: var(--primary-dark);}
    /* Modal and form scrollable styles */
    .modal-backdrop {
      display: none;
      position: fixed;
      z-index: 2000;
      left: 0; top: 0; right: 0; bottom: 0;
      background: rgba(20,30,40,0.68);
      backdrop-filter: blur(8px);
      justify-content: center;
      align-items: center;
    }
    .modal-backdrop.active { display: flex; }
    .modal-content {
      background: var(--card-bg);
      border-radius: 22px;
      max-width: 440px;
      width: 98vw;
      margin: auto;
      box-shadow: 0 8px 36px #151e28bb;
      color: #fff;
      position: relative;
      display: flex;
      flex-direction: column;
      animation: fadeInModal .3s cubic-bezier(.7,-0.08,.62,1.09);
      max-height: 95vh;
      overflow: hidden;
    }
    @keyframes fadeInModal {
      from { opacity: 0; transform: translateY(40px) scale(0.98);}
      to   { opacity: 1; transform: none;}
    }
    .modal-close {
      position: absolute;
      top: 18px; right: 22px;
      font-size: 32px;
      background: none;
      border: none;
      color: var(--primary);
      cursor: pointer;
      font-weight: 700;
      transition: color .18s;
      z-index: 1;
    }
    .modal-close:hover { color: #fff; }
    .modal-heading {
      font-size: 2rem;
      font-weight: 600;
      margin-bottom: 24px;
      letter-spacing: 0.5px;
      color: #fff;
      text-align: center;
      margin-top: 32px;
    }
    .scrollable-form-area {
      overflow-y: auto;
      padding: 22px 34px 22px 34px;
      flex: 1 1 auto;
      max-height: 70vh;
    }
    .form-group {
      margin-bottom: 15px;
      display: flex;
      flex-direction: column;
      gap: 7px;
    }
    .form-row {
      display: flex;
      gap: 16px;
      margin-bottom: 15px;
    }
    label {
      font-size: 1.09rem;
      color: #b8eecb;
      font-weight: 500;
      letter-spacing: 0.1px;
    }
    input, select, textarea {
      background: rgba(255,255,255,0.13);
      border: 1.5px solid #1db95455;
      color: #fff;
      border-radius: 9px;
      padding: 12px 12px;
      font-size: 1rem;
      font-family: inherit;
      outline: none;
      transition: border 0.17s, box-shadow 0.18s;
      box-shadow: 0 2px 13px rgba(29,185,84,0.06);
      resize: none;
    }
    input:focus, select:focus, textarea:focus {
      border: 1.5px solid #1db954;
      box-shadow: 0 0 0 1.5px #21c46466;
      background: rgba(35, 50, 80, 0.97);
    }
    .modal-submit {
      width: 100%;
      background: linear-gradient(90deg, #1db954 60%, #17a44b 100%);
      color: #fff;
      font-size: 1.17rem;
      font-weight: 600;
      padding: 15px 0;
      border: none;
      border-radius: 9px;
      margin-top: 15px;
      box-shadow: 0 2px 18px #1db9544a;
      cursor: pointer;
      transition: background 0.17s, box-shadow 0.17s;
      letter-spacing: 0.5px;
      margin-bottom: 18px;
    }
    .modal-submit:hover {
      background: #19a347;
      box-shadow: 0 5px 22px #1db95450;
    }
    .player-emails-list {
      display: flex; flex-wrap: wrap; gap: 7px;
      margin-bottom: 7px;
    }
    .player-email-item {
      background: #1db954ee;
      color: #fff;
      border-radius: 6px;
      padding: 4px 11px;
      font-size: 0.94rem;
      margin-right: 4px;
      display: flex; align-items: center;
      gap: 5px;
    }
    .remove-player-btn {
      background: none;
      border: none;
      color: #fff;
      font-weight: bold;
      font-size: 1.1em;
      cursor: pointer;
      margin-left: 3px;
      padding: 0 2px;
    }
    .add-player-row {
      display: flex; gap: 5px; margin-bottom: 10px;
    }
    .add-player-row input {
      flex: 1;
    }
    .add-player-btn {
      background: #1db954;
      color: #fff;
      border: none;
      border-radius: 7px;
      font-size: 16px;
      font-weight: 600;
      padding: 4px 14px;
      cursor: pointer;
      margin-left: 2px;
      transition: background 0.17s;
    }
    .add-player-btn:hover { background: #17a44b; }
    @media (max-width: 1020px) {
      .stats-row { flex-direction: column; gap: 17px;}
      .stat-card { min-width: 120px; }
    }
    @media (max-width: 700px) {
      header { padding: 16px 6vw 12px 6vw; }
      .main-content { padding: 0 2vw 32px 2vw;}
    }
    @media (max-width: 500px) {
      .modal-content { padding: 0;}
      .scrollable-form-area { padding: 6vw 3vw 6vw 3vw;}
      .form-row { flex-direction: column; gap: 7px;}
      .modal-heading { font-size: 1.2rem;}
      .stat-card { padding: 16px 9px 14px 9px; gap: 7px;}
      .main-content { margin-top: 15px; }
      .session-actions {
        position: static;
        margin-top: 15px;
        justify-content: flex-end;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="logo">
      <img src="https://i.pinimg.com/736x/95/d0/28/95d028d025dce543f046ee4468f3fbcc.jpg" alt="Logo">
      Player Dashboard
    </div>
    <div class="user-sec" id="user-sec" onclick="toggleProfileModal()">
      <div class="avatar" id="player-avatar">?</div>
      <span class="user-name" id="player-name">...</span>
    </div>
  </header>
  <!-- Profile Modal -->
  <div class="profile-modal-backdrop" id="profile-modal-backdrop" onclick="closeProfileModal(event)">
    <div class="profile-modal" id="profile-modal" onclick="event.stopPropagation()">
      <button class="close-btn" onclick="closeProfileModal(event)">&times;</button>
      <div class="avatar" id="profile-avatar">?</div>
      <div class="profile-name" id="profile-name">...</div>
      <div class="profile-email" id="profile-email">...</div>
      <button class="profile-logout-btn" onclick="signOut()">Logout</button>
    </div>
  </div>
  <div class="main-content">
    <!-- Stats Cards -->
    <div class="stats-row">
      <div class="stat-card">
        <span class="stat-icon"><i class="fas fa-trophy"></i></span>
        <div class="stat-info">
          <span class="stat-label">Created Sessions</span>
          <span class="stat-value" id="stat-created-sessions">0</span>
          <span class="stat-next-match" id="next-created-match">—</span>
        </div>
      </div>
      <div class="stat-card">
        <span class="stat-icon"><i class="fas fa-calendar-alt"></i></span>
        <div class="stat-info">
          <span class="stat-label">Joined Sessions</span>
          <span class="stat-value" id="stat-joined-sessions">0</span>
          <span class="stat-next-match" id="next-joined-match">—</span>
        </div>
      </div>
      <div class="stat-card">
        <span class="stat-icon"><i class="fas fa-users"></i></span>
        <div class="stat-info">
          <span class="stat-label">Available Sessions</span>
          <span class="stat-value" id="stat-available-sessions">0</span>
        </div>
      </div>
      <div class="stat-card">
        <span class="stat-icon"><i class="fas fa-cog"></i></span>
        <div class="stat-info">
          <span class="stat-label">Manage Sessions</span>
          <span class="stat-value" id="stat-manage-sessions">0</span>
        </div>
      </div>
    </div>
    <!-- Tabs -->
    <div class="tabs-row">
      <button class="tab-btn active" onclick="showTab('create')">Create Sessions</button>
      <button class="tab-btn" onclick="showTab('joined')">Joined Sessions</button>
      <button class="tab-btn" onclick="showTab('available')">Available Sessions</button>
      <button class="tab-btn" onclick="showTab('manage')">Manage My Sessions</button>
      <button class="tab-btn" onclick="showTab('cancelled')">Cancelled Sessions</button>
    </div>
    <!-- Create Session Tab -->
    <div class="tab-content" id="tab-create">
      <button class="create-session-btn" onclick="openSessionModal()">+ Create New Session</button>
    </div>
    <!-- Joined Sessions Tab -->
    <div class="tab-content" id="tab-joined" style="display:none;">
      <div class="manage-sessions-list" id="joined-sessions-list"></div>
    </div>
    <!-- Available Sessions Tab -->
    <div class="tab-content" id="tab-available" style="display:none;">
      <div class="manage-sessions-list" id="available-sessions-list"></div>
    </div>
    <!-- Manage My Sessions Tab -->
    <div class="tab-content" id="tab-manage" style="display:none;">
      <div class="manage-sessions-list" id="manage-sessions-list"></div>
    </div>
    <!-- Cancelled Sessions Tab -->
    <div class="tab-content" id="tab-cancelled" style="display:none;">
      <div class="cancelled-sessions-list" id="cancelled-sessions-list"></div>
    </div>
  </div>
  <!-- Modal: Create Session -->
  <div class="modal-backdrop" id="session-modal-backdrop" style="display:none;">
    <div class="modal-content">
      <button class="modal-close" onclick="closeSessionModal()">&times;</button>
      <div class="modal-heading">Create New Session</div>
      <div class="scrollable-form-area">
      <form id="create-session-form" autocomplete="off">
        <div class="form-group">
          <label for="sport">Sport</label>
          <select id="sport" required>
            <option value="">Select sport</option>
          </select>
        </div>
        <div class="form-group">
          <label for="venue">Venue</label>
          <input type="text" id="venue" placeholder="Enter venue location" required />
        </div>
        <div class="form-group">
          <label>Team 1 Players</label>
          <div class="player-emails-list" id="team1-list"></div>
          <div class="add-player-row">
            <input type="email" id="team1-input" placeholder="Enter player email" />
            <button type="button" class="add-player-btn" onclick="addPlayer('team1')">+</button>
          </div>
        </div>
        <div class="form-group">
          <label>Team 2 Players</label>
          <div class="player-emails-list" id="team2-list"></div>
          <div class="add-player-row">
            <input type="email" id="team2-input" placeholder="Enter player email" />
            <button type="button" class="add-player-btn" onclick="addPlayer('team2')">+</button>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group" style="flex:1;">
            <label for="date">Date</label>
            <input type="date" id="date" required min="" />
          </div>
          <div class="form-group" style="flex:1;">
            <label for="time">Time</label>
            <input type="time" id="time" required min="" />
          </div>
        </div>
        <div class="form-group">
          <label for="required">How many players required?</label>
          <input type="number" id="required" min="0" placeholder="Required players" />
        </div>
        <div class="form-group">
          <label for="description">Description (Optional)</label>
          <textarea id="description" rows="2" placeholder="Add session details..."></textarea>
        </div>
        <button class="modal-submit" type="submit">Create Session</button>
      </form>
      </div>
    </div>
  </div>
  <!-- Modal: Edit Session -->
  <div class="modal-backdrop" id="edit-session-modal-backdrop" style="display:none;">
    <div class="modal-content">
      <button class="modal-close" onclick="closeEditSessionModal()">&times;</button>
      <div class="modal-heading">Edit Session</div>
      <div class="scrollable-form-area">
      <form id="edit-session-form" autocomplete="off">
        <input type="hidden" id="edit-session-id" />
        <div class="form-group">
          <label for="edit-sport">Sport</label>
          <select id="edit-sport" required>
            <option value="">Select sport</option>
          </select>
        </div>
        <div class="form-group">
          <label for="edit-venue">Venue</label>
          <input type="text" id="edit-venue" placeholder="Enter venue location" required />
        </div>
        <div class="form-group">
          <label>Team 1 Players</label>
          <div class="player-emails-list" id="edit-team1-list"></div>
          <div class="add-player-row">
            <input type="email" id="edit-team1-input" placeholder="Enter player email" />
            <button type="button" class="add-player-btn" onclick="addEditPlayer('team1')">+</button>
          </div>
        </div>
        <div class="form-group">
          <label>Team 2 Players</label>
          <div class="player-emails-list" id="edit-team2-list"></div>
          <div class="add-player-row">
            <input type="email" id="edit-team2-input" placeholder="Enter player email" />
            <button type="button" class="add-player-btn" onclick="addEditPlayer('team2')">+</button>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group" style="flex:1;">
            <label for="edit-date">Date</label>
            <input type="date" id="edit-date" required min="" />
          </div>
          <div class="form-group" style="flex:1;">
            <label for="edit-time">Time</label>
            <input type="time" id="edit-time" required min="" />
          </div>
        </div>
        <div class="form-group">
          <label for="edit-required">How many players required?</label>
          <input type="number" id="edit-required" min="0" placeholder="Required players" />
        </div>
        <div class="form-group">
          <label for="edit-description">Description (Optional)</label>
          <textarea id="edit-description" rows="2" placeholder="Add session details..."></textarea>
        </div>
        <button class="modal-submit" type="submit">Save Changes</button>
      </form>
      </div>
    </div>
  </div>
  <script>
    // USER PROFILE
    let user = JSON.parse(localStorage.getItem('currentUser')) || {};

    function fillUserInfo() {
      if (!user || !user.fullname || !user.email) {
        window.location.href = "/login.html";
        return;
      }
      const initial = user.fullname.charAt(0).toUpperCase();
      document.getElementById("player-avatar").textContent = initial;
      document.getElementById("player-name").textContent = user.fullname;
      document.getElementById("profile-avatar").textContent = initial;
      document.getElementById("profile-name").textContent = user.fullname;
      document.getElementById("profile-email").textContent = user.email;
    }
    fillUserInfo();

    // TABS LOGIC
    function showTab(tab) {
      ['create','joined','available','manage','cancelled'].forEach(t => {
        document.getElementById('tab-'+t).style.display = t===tab ? '' : 'none';
        document.querySelectorAll('.tab-btn').forEach((btn,idx) => {
          btn.classList.toggle('active', 
            (tab==='create' && idx===0) || 
            (tab==='joined' && idx===1) || 
            (tab==='available' && idx===2) || 
            (tab==='manage' && idx===3) ||
            (tab==='cancelled' && idx===4)
          );
        });
      });
      if(tab==='joined') renderJoinedSessions();
      if(tab==='available') renderAvailableSessions();
      if(tab==='manage') renderManageSessions();
      if(tab==='cancelled') renderCancelledSessions();
    }

    // STATE
    let team1Emails = [], team2Emails = [];
    let editTeam1Emails = [], editTeam2Emails = [];
    let sports = [];
    let allSessions = [];

    // API HELPERS
    async function fetchSports() {
      const res = await fetch('/api/sports');
      if (!res.ok) return [];
      return await res.json();
    }
    async function fetchPlayerSessions() {
      const res = await fetch(`/api/sessions/player?email=${encodeURIComponent(user.email)}`);
      if (!res.ok) return [];
      return await res.json();
    }

    // RENDER SPORTS LIST INTO SELECT
    async function populateSportsDropdown() {
      sports = await fetchSports();
      const sel = document.getElementById('sport');
      sel.innerHTML = '<option value="">Select sport</option>';
      sports.forEach(sport => {
        sel.innerHTML += `<option value="${sport.name}">${sport.name}</option>`;
      });
    }
    async function populateEditSportsDropdown() {
      const sel = document.getElementById('edit-sport');
      sel.innerHTML = '<option value="">Select sport</option>';
      sports.forEach(sport => {
        sel.innerHTML += `<option value="${sport.name}">${sport.name}</option>`;
      });
    }

    // FETCH AND CLASSIFY SESSIONS
    async function reloadSessions() {
      allSessions = await fetchPlayerSessions();
      updateStats();
      renderAllSessionLists();
    }

    function updateStats() {
      const {created, joined, available, cancelled} = classifySessions();
      document.getElementById("stat-created-sessions").textContent = created.length;
      document.getElementById("stat-joined-sessions").textContent = joined.length;
      document.getElementById("stat-available-sessions").textContent = available.length;
      document.getElementById("stat-manage-sessions").textContent = created.length;
      
      // Update next match information
      updateNextMatchInfo(created, joined);
    }

    function updateNextMatchInfo(createdSessions, joinedSessions) {
      // Find next match from created sessions
      const upcomingCreated = createdSessions.filter(s => new Date(s.date) > new Date());
      let nextCreatedMatch = "—";
      if (upcomingCreated.length > 0) {
        const nextCreated = upcomingCreated.sort((a,b) => new Date(a.date) - new Date(b.date))[0];
        nextCreatedMatch = `${nextCreated.sport} (${formatDateShort(nextCreated.date)})`;
      }
      document.getElementById("next-created-match").textContent = nextCreatedMatch;
      
      // Find next match from joined sessions
      const upcomingJoined = joinedSessions.filter(s => new Date(s.date) > new Date());
      let nextJoinedMatch = "—";
      if (upcomingJoined.length > 0) {
        const nextJoined = upcomingJoined.sort((a,b) => new Date(a.date) - new Date(b.date))[0];
        nextJoinedMatch = `${nextJoined.sport} (${formatDateShort(nextJoined.date)})`;
      }
      document.getElementById("next-joined-match").textContent = nextJoinedMatch;
    }

    function formatDateShort(dtStr) {
      const dt = new Date(dtStr);
      return dt.toLocaleString('en-IN', {
        day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit'
      });
    }

function classifySessions() {
  // Categorize sessions for this player
  const created = allSessions.filter(s => s.createdBy === user.email);
  const joined = allSessions.filter(s => {
    if (s.createdBy === user.email) return false;
    const p = s.playerEmails.find(p => p.email === user.email);
    return p && p.joined && !p.cancelled;
  });
  const available = allSessions.filter(s => {
    if (s.createdBy === user.email) return false;
    const p = s.playerEmails.find(p => p.email === user.email);
    return p && !p.joined && !p.cancelled;
  });
  
  // Sessions where player personally cancelled
  const sessionsICancelled = allSessions.filter(s => {
    const p = s.playerEmails.find(p => p.email === user.email);
    return p && p.cancelled;
  });
  
  // Sessions created by player that have cancellations from others
  const sessionsICreatedWithCancellations = created.filter(s => 
    s.playerEmails.some(p => p.cancelled && p.email !== user.email)
  );
  
  return { 
    created, 
    joined, 
    available, 
    sessionsICancelled, 
    sessionsICreatedWithCancellations 
  };
}
    function formatDate(dtStr) {
      const dt = new Date(dtStr);
      return dt.toLocaleString('en-IN', {
        day: '2-digit', month: 'short', year: '2-digit', hour: '2-digit', minute: '2-digit'
      });
    }

    function renderAllSessionLists() {
      renderJoinedSessions();
      renderAvailableSessions();
      renderManageSessions();
      renderCancelledSessions();
    }

    function renderJoinedSessions() {
      const {joined} = classifySessions();
      const container = document.getElementById('joined-sessions-list');
      
      container.innerHTML = joined.map(s => `
        <div class="session-box">
          <div class="session-title">${s.sport} <span class="session-status joined">Joined</span></div>
          <div class="session-info-row"><strong>Venue:</strong> ${s.venue}</div>
          <div class="session-info-row"><strong>Date:</strong> ${formatDate(s.date)}</div>
          <div class="session-info-row"><strong>Required Players:</strong> ${s.requiredPlayers || 'Not specified'}</div>
          <div class="session-info-row"><strong>Created By:</strong> ${s.createdBy}</div>
          ${renderTeamInfo(s)}
          ${s.description ? `<div class="session-description-row"><strong>Description:</strong> ${s.description}</div>` : ''}
          <div class="session-actions">
            <button class="action-btn cancel" onclick="cancelSessionPrompt('${s._id}')">Cancel</button>
          </div>
        </div>
      `).join('') || "<div style='color:#b8eecb;'>No joined sessions yet.</div>";
    }

    function renderAvailableSessions() {
      const {available} = classifySessions();
      const container = document.getElementById('available-sessions-list');
      
      container.innerHTML = available.map(s => `
        <div class="session-box">
          <div class="session-title">${s.sport}</div>
          <div class="session-info-row"><strong>Venue:</strong> ${s.venue}</div>
          <div class="session-info-row"><strong>Date:</strong> ${formatDate(s.date)}</div>
          <div class="session-info-row"><strong>Required Players:</strong> ${s.requiredPlayers || 'Not specified'}</div>
          <div class="session-info-row"><strong>Created By:</strong> ${s.createdBy}</div>
          ${renderTeamInfo(s)}
          ${s.description ? `<div class="session-description-row"><strong>Description:</strong> ${s.description}</div>` : ''}
          <div class="session-actions">
            <button class="action-btn join" onclick="joinSession('${s._id}')">Join</button>
          </div>
        </div>
      `).join('') || "<div style='color:#b8eecb;'>No available sessions.</div>";
    }

    function renderManageSessions() {
      const {created} = classifySessions();
      const container = document.getElementById('manage-sessions-list');
      
      container.innerHTML = created.map(s => `
        <div class="session-box">
          <div class="session-title">${s.sport}</div>
          <div class="session-info-row"><strong>Venue:</strong> ${s.venue}</div>
          <div class="session-info-row"><strong>Date:</strong> ${formatDate(s.date)}</div>
          <div class="session-info-row"><strong>Required Players:</strong> ${s.requiredPlayers || 'Not specified'}</div>
          ${renderTeamInfo(s)}
          ${s.description ? `<div class="session-description-row"><strong>Description:</strong> ${s.description}</div>` : ''}
          <div class="session-actions">
            <button class="edit-session-btn" title="Edit" onclick="openEditSessionModal('${s._id}')"><i class="fas fa-pen"></i></button>
            <button class="delete-session-btn" title="Delete" onclick="deleteSession('${s._id}')"><i class="fas fa-trash"></i></button>
          </div>
        </div>
      `).join('') || "<div style='color:#b8eecb;'>No sessions created yet.</div>";
    }
function renderCancelledSessions() {
  const { sessionsICancelled, sessionsICreatedWithCancellations } = classifySessions();
  const container = document.getElementById('cancelled-sessions-list');
  
  // Combine both types of cancelled sessions
  const allCancelledSessions = [...sessionsICancelled, ...sessionsICreatedWithCancellations];
  
  container.innerHTML = allCancelledSessions.map(s => {
    const isCreator = s.createdBy === user.email;
    const userPlayer = s.playerEmails.find(p => p.email === user.email);
    const cancelledPlayers = s.playerEmails.filter(p => p.cancelled);
    
    if (isCreator) {
      // Player created this session, show "Cancelled by Players"
      return `
      <div class="session-box">
        <div class="session-title">${s.sport} <span class="session-status cancelled">Cancelled by Players</span></div>
        <div class="session-info-row"><strong>Venue:</strong> ${s.venue}</div>
        ${renderTeamInfo(s)}
        <div class="session-info-row"><strong>Date:</strong> ${formatDate(s.date)}</div>
        <div class="session-info-row"><strong>Required Players:</strong> ${s.requiredPlayers || 'Not specified'}</div>
        ${s.description ? `<div class="session-description-row"><strong>Description:</strong> ${s.description}</div>` : ''}
        <div class="cancelled-by-row">
          <strong>Players who cancelled:</strong><br/>
          ${cancelledPlayers.filter(p => p.email !== user.email).map(p => 
            `${p.email} (Reason: ${p.cancelReason || "No reason provided"})`
          ).join('<br/>')}
        </div>
      </div>
      `;
    } else {
      // Player cancelled this session, show "Cancelled by me"
      return `
      <div class="session-box">
        <div class="session-title">${s.sport} <span class="session-status cancelled">Cancelled by me</span></div>
        <div class="session-info-row"><strong>Venue:</strong> ${s.venue}</div>
        ${renderTeamInfo(s)}
        <div class="session-info-row"><strong>Date:</strong> ${formatDate(s.date)}</div>
        <div class="session-info-row"><strong>Required Players:</strong> ${s.requiredPlayers || 'Not specified'}</div>
        <div class="session-info-row"><strong>Created By:</strong> ${s.createdBy}</div>
        ${s.description ? `<div class="session-description-row"><strong>Description:</strong> ${s.description}</div>` : ''}
        <div class="cancelled-by-row">
          <strong>Your cancellation reason:</strong> ${userPlayer.cancelReason || "No reason provided"}
        </div>
      </div>
      `;
    }
  }).join('') || "<div style='color:#b8eecb;'>No cancelled sessions.</div>";
}
    function renderTeamInfo(session) {
      let team1Players = Array.isArray(session.team1) ? session.team1 : [];
      let team2Players = Array.isArray(session.team2) ? session.team2 : [];
      
      // If teams aren't defined but playerEmails are, split them into two teams
      if ((team1Players.length === 0 || team2Players.length === 0) && session.playerEmails && session.playerEmails.length > 0) {
        const allPlayers = session.playerEmails.map(p => p.email);
        const half = Math.ceil(allPlayers.length / 2);
        team1Players = allPlayers.slice(0, half);
        team2Players = allPlayers.slice(half);
      }
      
      return `
        <div class="session-teams-row"><strong>Team 1 Players:</strong> ${team1Players.join(', ')}</div>
        <div class="session-teams-row"><strong>Team 2 Players:</strong> ${team2Players.join(', ')}</div>
      `;
    }

    // --- JOIN SESSION ---
    async function joinSession(sessionId) {
      if(!confirm("Do you want to join this session?")) return;
      const res = await fetch('/api/sessions/join', {
        method: 'PATCH',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ sessionId, playerEmail: user.email })
      });
      const data = await res.json();
      if(res.ok) {
        alert("Successfully joined the session!");
        reloadSessions();
      } else {
        alert(data.message || "Unable to join session.");
      }
    }

    // --- CANCEL SESSION ---
    function cancelSessionPrompt(sessionId) {
      const reason = prompt("Enter reason for cancellation:");
      if(reason === null) return;
      cancelSession(sessionId, reason);
    }
    async function cancelSession(sessionId, reason) {
      const res = await fetch('/api/sessions/cancel', {
        method: 'PATCH',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ sessionId, playerEmail: user.email, reason })
      });
      const data = await res.json();
      if(res.ok) {
        alert("Cancelled session.");
        reloadSessions();
      } else {
        alert(data.message || "Unable to cancel session.");
      }
    }

    // --- DELETE SESSION ---
    async function deleteSession(id) {
      if(confirm("Delete this session?")) {
        const res = await fetch(`/api/sessions/${id}`, { method: 'DELETE' });
        if (res.ok) await reloadSessions();
        else alert('Error deleting session');
      }
    }

    // MODAL LOGIC FOR CREATE SESSION
    function openSessionModal() {
      populateSportsDropdown();
      // Set min date to today
      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth() + 1).padStart(2, '0');
      const dd = String(today.getDate()).padStart(2, '0');
      document.getElementById('date').min = `${yyyy}-${mm}-${dd}`;
      document.getElementById('date').value = `${yyyy}-${mm}-${dd}`;
      updateTimeMin();
      team1Emails = []; team2Emails = [];
      renderEmailLists();
      document.getElementById('session-modal-backdrop').style.display = 'flex';
      setTimeout(()=>document.getElementById('session-modal-backdrop').classList.add('active'),10);
    }
    function closeSessionModal() {
      const modal = document.getElementById('session-modal-backdrop');
      modal.classList.remove('active');
      setTimeout(()=>{ modal.style.display='none'; }, 210);
      document.getElementById('create-session-form').reset();
      team1Emails = []; team2Emails = [];
      renderEmailLists();
    }
    function addPlayer(team) {
      const input = document.getElementById(team + '-input');
      const email = input.value.trim();
      if (!email || !/^[^@]+@[^@]+\.[^@]+$/.test(email)) { input.value=''; return; }
      if (team === 'team1') {
        if (!team1Emails.includes(email)) team1Emails.push(email);
      } else {
        if (!team2Emails.includes(email)) team2Emails.push(email);
      }
      input.value = '';
      renderEmailLists();
    }
    function removePlayer(team, idx) {
      if (team === 'team1') team1Emails.splice(idx, 1);
      else team2Emails.splice(idx, 1);
      renderEmailLists();
    }
    function renderEmailLists() {
      const t1 = document.getElementById('team1-list'), t2 = document.getElementById('team2-list');
      t1.innerHTML = team1Emails.map((e,i)=>`<span class="player-email-item">${e}<button class="remove-player-btn" type="button" onclick="removePlayer('team1',${i})">&times;</button></span>`).join('');
      t2.innerHTML = team2Emails.map((e,i)=>`<span class="player-email-item">${e}<button class="remove-player-btn" type="button" onclick="removePlayer('team2',${i})">&times;</button></span>`).join('');
    }
    document.getElementById('date').addEventListener('change', updateTimeMin);
    function updateTimeMin() {
      const dateInput = document.getElementById('date');
      const timeInput = document.getElementById('time');
      const selectedDate = dateInput.value;
      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth() + 1).padStart(2, '0');
      const dd = String(today.getDate()).padStart(2, '0');
      if (selectedDate === `${yyyy}-${mm}-${dd}`) {
        const now = today.toTimeString().slice(0,5);
        timeInput.min = now;
      } else {
        timeInput.min = "";
      }
    }

    document.getElementById('create-session-form').onsubmit = async function(e){
      e.preventDefault();
      const sport = document.getElementById('sport').value;
      const venue = document.getElementById('venue').value;
      const date = document.getElementById('date').value;
      const time = document.getElementById('time').value;
      const required = document.getElementById('required').value;
      const description = document.getElementById('description').value;
      
      if(!team1Emails.length || !team2Emails.length) {
        alert("Please add at least one player to both teams (by email).");
        return;
      }
      
      const dt = new Date(date + "T" + time);
      const now = new Date();
      if(dt < now) {
        alert("Please select a future date and time.");
        return;
      }
      
      // Combine team1 and team2 and add creator's email if not in list
      const playerEmails = Array.from(new Set([...team1Emails, ...team2Emails, user.email]));
      
      const res = await fetch('/api/sessions', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          sport, venue, date, time,
          playerEmails,
          description,
          requiredPlayers: required,
          createdBy: user.email,
          team1: team1Emails,
          team2: team2Emails
        })
      });
      
      if(res.ok) {
        closeSessionModal();
        reloadSessions();
        alert("Session created. Invited players will see it when they login.");
      } else {
        const data = await res.json();
        alert(data.message || 'Error creating session');
      }
    };

    // EDIT SESSION MODAL
    function openEditSessionModal(sessionId) {
      const s = allSessions.find(sess => sess._id === sessionId && sess.createdBy === user.email);
      if (!s) return;
      
      // Fill the form:
      document.getElementById("edit-session-id").value = s._id;
      document.getElementById("edit-sport").value = s.sport;
      document.getElementById("edit-venue").value = s.venue;
      document.getElementById("edit-date").value = s.date ? s.date.slice(0,10) : "";
      document.getElementById("edit-time").value = s.date ? (new Date(s.date)).toISOString().slice(11,16) : "";
      document.getElementById("edit-required").value = s.requiredPlayers || "";
      document.getElementById("edit-description").value = s.description || "";
      
      // For teams, parse from session if available
      editTeam1Emails = Array.isArray(s.team1) ? [...s.team1] : [];
      editTeam2Emails = Array.isArray(s.team2) ? [...s.team2] : [];
      
      // If teams aren't defined but playerEmails are, split them into two teams
      if ((editTeam1Emails.length === 0 || editTeam2Emails.length === 0) && s.playerEmails && s.playerEmails.length > 0) {
        const allPlayers = s.playerEmails.map(p => p.email);
        const half = Math.ceil(allPlayers.length / 2);
        editTeam1Emails = allPlayers.slice(0, half);
        editTeam2Emails = allPlayers.slice(half);
      }
      
      renderEditEmailLists();
      populateEditSportsDropdown();
      
      document.getElementById('edit-session-modal-backdrop').style.display = 'flex';
      setTimeout(()=>document.getElementById('edit-session-modal-backdrop').classList.add('active'),10);
    }
    function closeEditSessionModal() {
      const modal = document.getElementById('edit-session-modal-backdrop');
      modal.classList.remove('active');
      setTimeout(()=>{ modal.style.display='none'; }, 210);
      document.getElementById('edit-session-form').reset();
      editTeam1Emails = [];
      editTeam2Emails = [];
      renderEditEmailLists();
    }
    function addEditPlayer(team) {
      const input = document.getElementById("edit-"+team+"-input");
      const email = input.value.trim();
      if (!email || !/^[^@]+@[^@]+\.[^@]+$/.test(email)) { input.value=''; return; }
      if (team === 'team1') {
        if (!editTeam1Emails.includes(email)) editTeam1Emails.push(email);
      } else {
        if (!editTeam2Emails.includes(email)) editTeam2Emails.push(email);
      }
      input.value = '';
      renderEditEmailLists();
    }
    function removeEditPlayer(team, idx) {
      if (team === 'team1') editTeam1Emails.splice(idx, 1);
      else editTeam2Emails.splice(idx, 1);
      renderEditEmailLists();
    }
    function renderEditEmailLists() {
      const t1 = document.getElementById('edit-team1-list'), t2 = document.getElementById('edit-team2-list');
      t1.innerHTML = editTeam1Emails.map((e,i)=>`<span class="player-email-item">${e}<button class="remove-player-btn" type="button" onclick="removeEditPlayer('team1',${i})">&times;</button></span>`).join('');
      t2.innerHTML = editTeam2Emails.map((e,i)=>`<span class="player-email-item">${e}<button class="remove-player-btn" type="button" onclick="removeEditPlayer('team2',${i})">&times;</button></span>`).join('');
    }

    document.getElementById('edit-session-form').onsubmit = async function(e){
      e.preventDefault();
      const id = document.getElementById("edit-session-id").value;
      const sport = document.getElementById("edit-sport").value;
      const venue = document.getElementById("edit-venue").value;
      const date = document.getElementById("edit-date").value;
      const time = document.getElementById("edit-time").value;
      const required = document.getElementById("edit-required").value;
      const description = document.getElementById("edit-description").value;
      
      if(!editTeam1Emails.length || !editTeam2Emails.length) {
        alert("Please add at least one player to both teams (by email).");
        return;
      }
      
      const playerEmails = Array.from(new Set([...editTeam1Emails, ...editTeam2Emails, user.email]));
      
      const res = await fetch(`/api/sessions/${id}`, {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          sport,
          venue,
          date,
          time,
          playerEmails,
          description,
          requiredPlayers: required,
          team1: editTeam1Emails,
          team2: editTeam2Emails
        })
      });
      
      if(res.ok) {
        await reloadSessions();
        closeEditSessionModal();
        alert("Session updated.");
      } else {
        alert('Error updating session');
      }
    };

    // PROFILE MODAL LOGIC
    function toggleProfileModal() {
      const backdrop = document.getElementById('profile-modal-backdrop');
      backdrop.classList.toggle('active');
    }
    function closeProfileModal(e) {
      if (e && e.target && (e.target.id === "profile-modal-backdrop" || e.target.classList.contains('close-btn'))) {
        document.getElementById('profile-modal-backdrop').classList.remove('active');
      }
    }
    function signOut() {
      localStorage.removeItem("currentUser");
      window.location.href = '/login.html';
    }

    // ON LOAD
    (function init() {
      populateSportsDropdown();
      reloadSessions();
    })();
  </script>
</body>
</html>